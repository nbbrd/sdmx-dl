<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDMX-DL API Explorer</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <!-- Plotly.js v3.3.1 - Latest stable version -->
    <script src="https://cdn.plot.ly/plotly-3.3.1.min.js" charset="utf-8"></script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            vertical-align: middle;
            font-size: inherit;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 0;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .container.hide-header header {
            display: none;
        }

        header {
            background: #003D6D;
            color: white;
            padding: 20px 40px;
            border-bottom: 3px solid #0066cc;
        }

        header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            font-weight: 600;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        header h1 .material-symbols-outlined {
            font-size: 1.2em;
        }

        header p {
            font-size: 0.95em;
            opacity: 0.95;
            font-weight: 300;
        }

        .content {
            padding: 30px 40px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #003D6D;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #0066cc;
            font-size: 1.4em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section h2 .material-symbols-outlined {
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #003D6D;
            font-weight: 600;
            font-size: 0.95em;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #003D6D;
            border-radius: 3px;
            font-size: 0.95em;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.1);
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .button-group .dropdown:last-child {
            margin-left: auto;
        }

        /* Dropdown styles */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-button {
            padding: 10px 20px;
            background: #003D6D;
            color: white;
            border: 1px solid #003D6D;
            border-radius: 3px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dropdown-button:hover {
            background: #0066cc;
            border-color: #0066cc;
        }

        .dropdown-arrow {
            font-size: 0.8em;
            transition: transform 0.3s;
        }

        .dropdown.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 160px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
            border-radius: 3px;
            z-index: 1000;
            top: 100%;
            right: 0;
            margin-top: 2px;
        }

        .dropdown.open .dropdown-content {
            display: block;
        }

        .dropdown-content a {
            color: #333;
            padding: 10px 15px;
            text-decoration: none;
            display: block;
            font-size: 0.9em;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }

        .dropdown-content a:last-child {
            border-bottom: none;
        }

        .dropdown-content a:hover {
            background-color: #f8f9fa;
            color: #003D6D;
        }

        .dropdown-content a.active {
            background-color: #003D6D;
            color: white;
        }

        button {
            padding: 10px 20px;
            background: #003D6D;
            color: white;
            border: 1px solid #003D6D;
            border-radius: 3px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        button .material-symbols-outlined {
            font-size: 20px;
        }

        button:hover {
            background: #0066cc;
            border-color: #0066cc;
        }

        button:active {
            background: #002D5D;
            transform: none;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .response-container {
            background: #f8f9fa;
            border: 1px solid #d0d0d0;
            border-left: 3px solid #0066cc;
            border-radius: 0;
            padding: 15px 20px;
            margin-top: 20px;
            max-height: 500px;
            overflow: auto;
        }

        .response-container pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.5;
            color: #333;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: #fff5f5;
            border-left-color: #cc0000;
            color: #cc0000;
        }

        .success {
            background: #f5fff5;
            border-left-color: #00cc00;
            color: #006600;
        }

        .info-box {
            background: #e8f4f8;
            border-left: 4px solid #003D6D;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 0;
            color: #003D6D;
        }

        .info-box strong {
            color: #003D6D;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tabs.hide-others .tab:not(.active) {
            display: none;
        }

        .tabs.hide-others {
            display: none;
        }

        .tab {
            padding: 12px 20px;
            background: transparent;
            color: #666;
            cursor: pointer;
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            font-size: 0.95em;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #003D6D;
            background: #f8f9fa;
            transform: none;
            box-shadow: none;
        }

        .tab.active {
            color: #003D6D;
            border-bottom-color: #0066cc;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .quick-links {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .quick-links a {
            padding: 6px 14px;
            background: transparent;
            color: white;
            text-decoration: none;
            border: 1px solid white;
            border-radius: 3px;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .quick-links a:hover {
            background: #003D6D;
            color: white;
        }

        .chart-container {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 0; /* remove inner padding to let chart fill fully */
            margin-top: 20px;
            position: relative;
            height: 60vh; /* use viewport height for better space usage */
            display: flex;
            flex-direction: column;
        }
        #data-chart {
            flex: 1 1 auto; /* allow to grow and fill container */
            width: 100%;
            height: 100%;
        }
        .chart-wrapper {
            display: none;
        }

        .chart-wrapper.active {
            display: block;
        }

        .table-container {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
            overflow: auto;
            max-height: 600px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table thead {
            position: sticky;
            top: 0;
            background: #003D6D;
            color: white;
            z-index: 10;
        }

        .data-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e0e0e0;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .data-table tbody tr:nth-child(even) {
            background: #fafbfc;
        }

        .data-table tbody tr:nth-child(even):hover {
            background: #f0f1f3;
        }

        .series-header {
            background: #e3f2fd !important;
            font-weight: 600;
            color: #1976d2;
        }

        .table-summary {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 13px;
            color: #666;
        }

        .table-summary strong {
            color: #333;
        }

        .key-builder-container {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
        }

        .dimension-row {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .dimension-label {
            flex: 0 0 150px;
            font-weight: 600;
            color: #333;
        }

        .dimension-label .dim-id {
            color: #003D6D;
            font-size: 12px;
            display: block;
            font-weight: 400;
        }

        .dimension-input {
            flex: 1;
        }

        .dimension-input select,
        .dimension-input input {
            width: 100%;
        }

        .built-key-container {
            background: white;
            border: 2px solid #003D6D;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
        }

        .built-key-container h3 {
            margin: 0 0 15px 0;
            color: #003D6D;
            font-size: 18px;
        }

        .built-key {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            word-break: break-all;
        }

        .key-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .wildcard-btn {
            padding: 4px 8px;
            font-size: 12px;
            background: #f0f1f3;
            color: #666;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wildcard-btn:hover {
            background: #e0e1e3;
            color: #333;
            transform: none;
            box-shadow: none;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .key-input-mode-toggle {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .key-input-mode-toggle button {
            flex: 1;
            padding: 10px 20px;
            background: white;
            color: #003D6D;
            border: 2px solid #003D6D;
            font-size: 14px;
        }

        .key-input-mode-toggle button.active {
            background: #003D6D;
            color: white;
        }

        .quick-key-input-container {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
        }

        .quick-key-input-container h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #333;
        }

        .quick-key-wrapper {
            position: relative;
        }

        .quick-key-input {
            width: 100%;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            transition: border-color 0.3s;
        }

        .quick-key-input:focus {
            outline: none;
            border-color: #003D6D;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #003D6D;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background: #f8f9fa;
        }

        .autocomplete-item.selected {
            background: #003D6D;
            color: white;
        }

        .autocomplete-item .code {
            font-weight: 600;
            color: #003D6D;
        }

        .autocomplete-item.selected .code {
            color: white;
        }

        .autocomplete-item .description {
            color: #666;
            font-size: 12px;
            margin-left: 10px;
        }

        .autocomplete-item.selected .description {
            color: rgba(255, 255, 255, 0.9);
        }

        .quick-key-hint {
            margin-top: 10px;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 4px;
            font-size: 13px;
            color: #1976d2;
        }

        .tree-progress {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
        }

        .tree-progress-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .tree-progress-bar-container {
            background: #e0e0e0;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
        }

        .tree-progress-bar {
            background: linear-gradient(90deg, #003D6D 0%, #0066cc 100%);
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .tree-progress-text {
            margin-top: 8px;
            font-size: 13px;
            color: #003D6D;
            font-weight: 600;
            text-align: center;
        }

        /* Hierarchical Tree View Styles */
        .hierarchy-key-builder-container {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
        }

        .hierarchy-key-builder-container h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #003D6D;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hierarchy-builder-content {
            margin-top: 20px;
        }

        .hierarchy-dimension {
            margin-bottom: 30px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
        }

        .hierarchy-dimension-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .hierarchy-dimension-info h4 {
            margin: 0 0 5px 0;
            color: #003D6D;
            font-size: 16px;
            font-weight: 700;
        }

        .hierarchy-dimension-id {
            font-size: 12px;
            color: #666;
            font-family: 'Courier New', monospace;
        }

        .hierarchy-selected-value {
            padding: 8px 16px;
            background: #003D6D;
            color: white;
            border-radius: 4px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hierarchy-tree {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .hierarchy-node {
            position: relative;
            padding: 0;
            margin-bottom: 8px;
        }

        .hierarchy-node-content {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            user-select: none;
            background: white;
            border: 2px solid #e0e0e0;
        }

        .hierarchy-node-content:hover {
            background: #f8f9fa;
            border-color: #003D6D;
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0, 61, 109, 0.15);
        }

        .hierarchy-node-content.selected {
            background: #003D6D;
            color: white;
            font-weight: 600;
            border-color: #003D6D;
        }

        .hierarchy-node-wildcard .hierarchy-node-content {
            background: #fff3e0;
            border-color: #ff9800;
            border-width: 2px;
            border-style: dashed;
        }

        .hierarchy-node-wildcard .hierarchy-node-content:hover {
            background: #ffe0b2;
            border-color: #f57c00;
            box-shadow: 0 2px 8px rgba(245, 124, 0, 0.25);
        }

        .hierarchy-node-label {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hierarchy-node-code {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #003D6D;
            font-size: 13px;
            min-width: 100px;
        }

        .hierarchy-node-content.selected .hierarchy-node-code {
            color: white;
        }

        .hierarchy-node-name {
            flex: 1;
            font-size: 13px;
            color: #333;
        }

        .hierarchy-node-content.selected .hierarchy-node-name {
            color: white;
        }

        .hierarchy-search {
            margin-bottom: 15px;
        }

        .hierarchy-search input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #003D6D;
            border-radius: 4px;
            font-size: 14px;
        }

        .hierarchy-stats {
            margin-top: 10px;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 4px;
            font-size: 12px;
            color: #1976d2;
            text-align: center;
        }

        .hierarchy-breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .hierarchy-breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: #f8f9fa;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .hierarchy-breadcrumb-item:hover {
            background: #003D6D;
            color: white;
        }

        .hierarchy-breadcrumb-separator {
            color: #999;
        }

        .meta-pretty-container {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
        }

        .meta-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #003D6D;
        }

        .meta-section h3 {
            color: #003D6D;
            margin: 0 0 15px 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .meta-section h3 .material-symbols-outlined {
            font-size: 24px;
        }

        h3 .material-symbols-outlined {
            vertical-align: middle;
            margin-right: 6px;
        }

        .meta-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .meta-info-item {
            background: white;
            padding: 12px 15px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .meta-info-label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .meta-info-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .meta-info-value code {
            background: #f0f1f3;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .dimensions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 6px;
            overflow: hidden;
        }

        .dimensions-table thead {
            background: #003D6D;
            color: white;
        }

        .dimensions-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        .dimensions-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
        }

        .dimensions-table tbody tr:hover {
            background: #f8f9fa;
        }

        .dimensions-table tbody tr:last-child td {
            border-bottom: none;
        }

        .dimension-position {
            font-weight: 600;
            color: #003D6D;
            font-size: 16px;
        }

        .codelist-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .codelist-preview {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
            max-height: 100px;
            overflow-y: auto;
        }

        .code-item {
            padding: 4px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .code-item:last-child {
            border-bottom: none;
        }

        .code-key {
            font-weight: 600;
            color: #003D6D;
            font-family: 'Courier New', monospace;
        }

        .attributes-list {
            background: white;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .attribute-item {
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .attribute-item:last-child {
            border-bottom: none;
        }

        .attribute-name {
            font-weight: 600;
            color: #333;
        }

        .attribute-id {
            font-family: 'Courier New', monospace;
            color: #666;
            font-size: 12px;
        }

        .sources-pretty-container {
            padding: 20px;
        }

        .sources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .source-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .source-card:hover {
            border-color: #003D6D;
            box-shadow: 0 4px 12px rgba(0, 61, 109, 0.15);
            transform: translateY(-2px);
        }

        .source-card.expanded {
            border-color: #003D6D;
            box-shadow: 0 4px 16px rgba(0, 61, 109, 0.25);
        }

        .source-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f1f3;
        }

        .source-icon {
            font-size: 32px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #003D6D;
            border-radius: 8px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .source-icon img {
            object-fit: contain;
            background: white;
            border-radius: 4px;
            padding: 4px;
        }

        .source-title {
            flex: 1;
        }

        .source-id {
            font-size: 18px;
            font-weight: 700;
            color: #003D6D;
            margin: 0;
            font-family: 'Courier New', monospace;
        }

        .source-name {
            font-size: 13px;
            color: #666;
            margin: 4px 0 0 0;
            font-weight: 500;
        }

        .source-details {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .source-detail-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 13px;
        }

        .source-detail-label {
            color: #003D6D;
            font-weight: 600;
            min-width: 80px;
            flex-shrink: 0;
        }

        .source-detail-value {
            color: #333;
            flex: 1;
            word-break: break-word;
        }

        .source-detail-value code {
            background: #f0f1f3;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .source-properties {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
        }

        .source-properties-title {
            font-size: 12px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .source-property {
            background: #f8f9fa;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .source-property-key {
            color: #003D6D;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .source-property-value {
            color: #333;
            font-family: 'Courier New', monospace;
        }


        .filter-box {
            position: relative;
            margin-bottom: 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
        }

        .filter-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            position: relative;
        }

        .filter-input-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
        }

        .filter-box input {
            width: 100%;
            padding: 8px 150px 8px 12px;
            font-size: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            transition: all 0.3s;
            background: white;
        }

        .filter-box input:focus {
            border-color: #003D6D;
            box-shadow: 0 0 0 2px rgba(0, 61, 109, 0.1);
            outline: none;
        }

        .filter-inline-buttons {
            position: absolute;
            right: 8px;
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .filter-clear-btn {
            padding: 2px 6px;
            background: #f5f5f5;
            border: 1px solid #ccc;
            border-radius: 50%;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: #666;
            min-width: 22px;
            width: 22px;
            height: 22px;
            text-align: center;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .filter-clear-btn:hover {
            background: #e8e8e8;
        }

        .filter-clear-btn.active {
            background: #003D6D;
            color: white;
            border-color: #003D6D;
        }

        .filter-inline-btn {
            padding: 2px 6px;
            background: #f5f5f5;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: #666;
            min-width: 20px;
            text-align: center;
            user-select: none;
        }

        .filter-inline-btn:hover {
            background: #e8e8e8;
        }

        .filter-inline-btn.active {
            background: #003D6D;
            color: white;
            border-color: #003D6D;
        }

        .filter-actions {
            display: flex;
            gap: 8px;
        }

        .filter-action-btn {
            padding: 6px 10px;
            background: #f5f5f5;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            color: #666;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .filter-action-btn:hover {
            background: #e8e8e8;
        }

        .filter-action-btn.active {
            background: #003D6D;
            color: white;
            border-color: #003D6D;
        }

        .filter-options-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }


        .filter-count {
            font-size: 12px;
            color: #666;
            font-weight: 600;
            background: #f0f1f3;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: auto;
        }

        .source-card.filtered-hidden {
            display: none;
        }

        .source-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .source-card.expanded .source-actions {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .source-click-hint {
            font-size: 11px;
            color: #999;
            text-align: center;
            margin-top: 10px;
            font-style: italic;
        }

        .source-card.expanded .source-click-hint {
            display: none;
        }

        .source-actions-title {
            font-size: 12px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .source-action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .source-action-btn {
            padding: 6px 12px;
            background: white;
            color: #003D6D;
            border: 1px solid #003D6D;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .source-action-btn:hover {
            background: #003D6D;
            color: white;
            text-decoration: none;
        }

        .source-action-btn:active {
            transform: scale(0.98);
        }

        .flows-pretty-container {
            padding: 20px;
        }


        .flows-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .flow-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .flow-card:hover {
            border-color: #003D6D;
            box-shadow: 0 4px 12px rgba(0, 61, 109, 0.15);
            transform: translateY(-2px);
        }

        .flow-card.filtered-hidden {
            display: none;
        }

        .flow-card.expanded {
            border-color: #003D6D;
            box-shadow: 0 4px 16px rgba(0, 61, 109, 0.25);
        }

        .flow-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f1f3;
        }

        .flow-icon {
            font-size: 32px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #003D6D;
            border-radius: 8px;
            flex-shrink: 0;
            color: white;
        }

        .flow-title {
            flex: 1;
        }

        .flow-id {
            font-size: 16px;
            font-weight: 700;
            color: #003D6D;
            margin: 0;
            font-family: 'Courier New', monospace;
        }

        .flow-name {
            font-size: 14px;
            color: #333;
            margin: 4px 0 0 0;
            font-weight: 600;
        }

        .flow-description {
            font-size: 13px;
            color: #666;
            margin-top: 10px;
            line-height: 1.5;
        }

        .flow-meta {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .flow-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #666;
        }

        .flow-meta-item code {
            background: #f0f1f3;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #003D6D;
        }

        .flow-click-hint {
            font-size: 11px;
            color: #999;
            text-align: center;
            margin-top: 10px;
            font-style: italic;
        }

        .flow-card.expanded .flow-click-hint {
            display: none;
        }

        .flow-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .flow-card.expanded .flow-actions {
            display: block;
        }

        .flow-actions-title {
            font-size: 12px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .flow-action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .flow-action-btn {
            padding: 6px 12px;
            background: white;
            color: #003D6D;
            border: 1px solid #003D6D;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .flow-action-btn:hover {
            background: #003D6D;
            color: white;
            text-decoration: none;
        }

        .flow-action-btn:active {
            transform: scale(0.98);
        }

        .about-pretty-container {
            padding: 20px;
        }

        .about-header {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 30px;
            background: #003D6D;
            color: white;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .about-icon {
            font-size: 64px;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            flex-shrink: 0;
        }

        .about-title {
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 8px 0;
            color: white;
        }

        .about-subtitle {
            font-size: 16px;
            margin: 0;
            opacity: 0.95;
            font-weight: 400;
        }

        .about-content {
            background: white;
        }

        .about-section {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 4px solid #003D6D;
        }

        .about-section-title {
            color: #003D6D;
            font-size: 20px;
            font-weight: 700;
            margin: 0 0 20px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .about-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .about-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s;
        }

        .about-item:hover {
            border-color: #003D6D;
            box-shadow: 0 2px 8px rgba(0, 61, 109, 0.15);
        }

        .about-label {
            display: block;
            font-size: 12px;
            color: #003D6D;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .about-value {
            display: block;
            font-size: 15px;
            color: #333;
            font-weight: 600;
        }

        .about-value code {
            background: #f0f1f3;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #003D6D;
            font-weight: 600;
        }

        .about-properties {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .about-property {
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .about-property:last-child {
            border-bottom: none;
        }

        .about-property-key {
            font-weight: 700;
            color: #003D6D;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            min-width: 180px;
            flex-shrink: 0;
        }

        .about-property-value {
            color: #333;
            font-size: 13px;
            word-break: break-word;
        }

        /* Micro-interactions */
        :root {
            --elev-0: 0 0 0 rgba(0,0,0,0);
            --elev-1: 0 2px 4px rgba(0,0,0,0.08);
            --elev-2: 0 6px 12px rgba(0,0,0,0.12);
        }

        .tab,
        button,
        .dropdown-button,
        .source-card,
        .flow-card,
        .about-item,
        .filter-action-btn,
        .source-action-btn,
        .flow-action-btn {
            transition: background-color 160ms ease, color 160ms ease, transform 160ms ease, box-shadow 160ms ease, border-color 160ms ease, opacity 160ms ease;
        }

        /* Button ripple */
        button { position: relative; overflow: hidden; }
        .ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: ripple 500ms linear;
            background-color: rgba(255,255,255,0.6);
            pointer-events: none;
        }
        @keyframes ripple { to { transform: scale(4); opacity: 0; } }

        /* Elevations on hover */
        .source-card { box-shadow: var(--elev-1); }
        .source-card:hover { box-shadow: var(--elev-2); transform: translateY(-2px); }
        .flow-card { box-shadow: var(--elev-1); }
        .flow-card:hover { box-shadow: var(--elev-2); transform: translateY(-2px); }
        .about-item { box-shadow: var(--elev-0); }
        .about-item:hover { box-shadow: var(--elev-1); transform: translateY(-1px); }

        /* Dropdown smooth open */
        .dropdown-content { opacity: 0; transform: translateY(-4px); transition: opacity 160ms ease, transform 160ms ease; }
        .dropdown.open .dropdown-content { opacity: 1; transform: translateY(0); }

        /* Tab-content fade */
        .tab-content { opacity: 0; transform: translateY(4px); transition: opacity 180ms ease, transform 180ms ease; }
        .tab-content.active { opacity: 1; transform: translateY(0); }

        /* Focus-visible outlines */
        .tab:focus-visible,
        button:focus-visible,
        input:focus-visible,
        select:focus-visible,
        .dropdown-button:focus-visible {
            outline: 2px solid #66afe9;
            outline-offset: 2px;
        }

        /* Filter inline buttons subtle press */
        .filter-inline-btn:active,
        .filter-clear-btn:active,
        .source-action-btn:active,
        .flow-action-btn:active {
            transform: scale(0.98);
        }

        /* Source/Flow header icon pulse on expand */
        .source-card.expanded .source-icon,
        .flow-card.expanded .flow-icon { animation: pulse 320ms ease-in-out; }
        @keyframes pulse { 50% { transform: scale(1.06); } }

        /* View toggles subtle highlight on hover */
        .view-toggle button:hover { filter: brightness(1.05); }

        /* Filter box input leading icon space: animate placeholder color on focus */
        .filter-box input::placeholder { color: #999; transition: color 160ms ease; }
        .filter-box input:focus::placeholder { color: #bbb; }

        /* View toggle buttons - discreet floating controls */
        .view-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }

        .view-toggle-btn {
            background: white;
            border: 1px solid #ddd;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.2s ease;
            color: #666;
            font-size: 20px;
            padding: 0;
        }

        .view-toggle-btn:hover {
            background: #f8f9fa;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
            color: #003D6D;
        }

        .view-toggle-btn:active {
            transform: translateY(0) scale(0.95);
        }

        .view-toggle-btn.active {
            background: #003D6D;
            color: white;
            border-color: #003D6D;
        }

        .view-toggle-btn .material-symbols-outlined {
            font-size: 20px;
        }

        .view-toggle-btn[title]::after {
            content: attr(title);
            position: absolute;
            right: 52px;
            background: #333;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .view-toggle-btn:hover[title]::after {
            opacity: 1;
        }

        .view-menu {
            position: absolute;
            bottom: 52px;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 180px;
            overflow: hidden;
            animation: slideUp 0.2s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .view-menu-item {
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: white;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
            color: #333;
            font-size: 14px;
            text-align: left;
        }

        .view-menu-item:hover {
            background: #f8f9fa;
        }

        .view-menu-item.active {
            background: #e8f4f8;
            color: #003D6D;
        }

        .view-menu-item .material-symbols-outlined {
            font-size: 20px;
            color: #666;
        }

        .view-menu-item:hover .material-symbols-outlined,
        .view-menu-item.active .material-symbols-outlined {
            color: #003D6D;
        }

        .view-menu-item + .view-menu-item {
            border-top: 1px solid #f0f0f0;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            max-width: 800px;
            max-height: 85vh;
            width: 90%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, #003D6D 0%, #0066cc 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-header .material-symbols-outlined {
            font-size: 24px;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-close .material-symbols-outlined {
            font-size: 24px;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .help-section {
            margin-bottom: 32px;
        }

        .help-section:last-child {
            margin-bottom: 0;
        }

        .help-section h3 {
            margin: 0 0 16px 0;
            color: #003D6D;
            font-size: 18px;
            font-weight: 600;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        .help-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 12px;
        }

        .help-table tr {
            border-bottom: 1px solid #f0f0f0;
        }

        .help-table tr:last-child {
            border-bottom: none;
        }

        .help-table td {
            padding: 12px 8px;
            vertical-align: top;
        }

        .param-name {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #003D6D;
            font-size: 14px;
            width: 140px;
        }

        .param-desc {
            color: #333;
            font-size: 14px;
            width: 240px;
        }

        .param-example {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #666;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .help-note {
            margin: 8px 0 0 0;
            padding: 12px;
            background: #fff9e6;
            border-left: 4px solid #ffc107;
            color: #666;
            font-size: 13px;
            line-height: 1.5;
        }

        .help-note code {
            background: rgba(0, 0, 0, 0.05);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .help-example {
            margin-bottom: 16px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #003D6D;
        }

        .help-example:last-child {
            margin-bottom: 0;
        }

        .help-example strong {
            display: block;
            margin-bottom: 8px;
            color: #003D6D;
            font-size: 14px;
        }

        .help-example code {
            display: block;
            padding: 8px 12px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #333;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><span class="material-symbols-outlined">query_stats</span> SDMX-DL API Explorer</h1>
            <p>Easily download official statistics via REST API</p>
            <div class="quick-links">
                <a href="/q/swagger-ui" target="_blank">Swagger UI</a>
                <a href="/q/openapi" target="_blank">OpenAPI Spec</a>
            </div>
        </header>

        <div class="content">

            <div class="tabs">
                <button class="tab active" onclick="switchTab('about')">About</button>
                <button class="tab" onclick="switchTab('sources')">Sources</button>
                <button class="tab" onclick="switchTab('databases')">Databases</button>
                <button class="tab" onclick="switchTab('flows')">Flows</button>
                <button class="tab" onclick="switchTab('flowsearch')">Flow Search</button>
                <button class="tab" onclick="switchTab('meta')">Meta</button>
                <button class="tab" onclick="switchTab('keybuilder')">Key Builder</button>
                <button class="tab" onclick="switchTab('data')">Data</button>
                <button class="tab" onclick="switchTab('compare')">Compare</button>
            </div>

            <!-- About Tab -->
            <div id="about-tab" class="tab-content active">
                <div class="section">
                    <h2>About SDMX-DL</h2>
                    <div class="button-group">
                        <button onclick="getAbout()">Get Information</button>
                        <div class="dropdown" id="about-copy-dropdown" style="display: none;">
                            <button class="dropdown-button" onclick="toggleAboutCopyDropdown()">
                                <span class="material-symbols-outlined">content_copy</span> Copy <span class="dropdown-arrow"></span>
                            </button>
                            <div class="dropdown-content" id="about-copy-dropdown-content">
                                <a href="#" onclick="copyAboutJSON()"><span class="material-symbols-outlined">code</span> Copy JSON</a>
                                <a href="#" onclick="copyAboutCurlBash()"><span class="material-symbols-outlined">terminal</span> Copy as cURL (bash)</a>
                                <a href="#" onclick="copyAboutCurlCmd()"><span class="material-symbols-outlined">terminal</span> Copy as cURL (cmd)</a>
                                <a href="#" onclick="copyAboutCurlPowerShell()"><span class="material-symbols-outlined">terminal</span> Copy as PowerShell</a>
                            </div>
                        </div>
                    </div>
                    <div id="about-pretty-view" class="chart-wrapper active" style="display: none;">
                        <div class="about-pretty-container" id="about-pretty-content"></div>
                    </div>
                </div>
            </div>

            <!-- Sources Tab -->
            <div id="sources-tab" class="tab-content">
                <div class="section">
                    <h2>List SDMX Sources</h2>
                    <p style="margin-bottom: 15px; color: #666;">Browse available SDMX data sources</p>
                    <div class="button-group">
                        <button onclick="getSources()">Get Sources</button>
                        <div class="dropdown" id="sources-copy-dropdown" style="display: none;">
                            <button class="dropdown-button" onclick="toggleSourcesCopyDropdown()">
                                <span class="material-symbols-outlined">content_copy</span> Copy <span class="dropdown-arrow"></span>
                            </button>
                            <div class="dropdown-content" id="sources-copy-dropdown-content">
                                <a href="#" onclick="copySourcesJSON()"><span class="material-symbols-outlined">code</span> Copy JSON</a>
                                <a href="#" onclick="copySourcesCurlBash()"><span class="material-symbols-outlined">terminal</span> Copy as cURL (bash)</a>
                                <a href="#" onclick="copySourcesCurlCmd()"><span class="material-symbols-outlined">terminal</span> Copy as cURL (cmd)</a>
                                <a href="#" onclick="copySourcesCurlPowerShell()"><span class="material-symbols-outlined">terminal</span> Copy as PowerShell</a>
                            </div>
                        </div>
                    </div>

                    <div id="sources-pretty-view" class="chart-wrapper active" style="display: none;">
                        <div class="sources-pretty-container" id="sources-pretty-content"></div>
                    </div>
                </div>
            </div>

            <!-- Databases Tab -->
            <div id="databases-tab" class="tab-content">
                <div class="section">
                    <h2>List Databases</h2>
                    <div class="form-group">
                        <label for="db-source">Source ID:</label>
                        <input type="text" id="db-source" list="sources-list" placeholder="e.g., ECB">
                    </div>
                    <div class="button-group">
                        <button onclick="getDatabases()">Get Databases</button>
                        <div class="dropdown" id="databases-copy-dropdown" style="display: none;">
                            <button class="dropdown-button" onclick="toggleDatabasesCopyDropdown()">
                                <span class="material-symbols-outlined">content_copy</span> Copy <span class="dropdown-arrow"></span>
                            </button>
                            <div class="dropdown-content" id="databases-copy-dropdown-content">
                                <a href="#" onclick="copyDatabasesJSON()"><span class="material-symbols-outlined">code</span> Copy JSON</a>
                                <a href="#" onclick="copyDatabasesCurlBash()"><span class="material-symbols-outlined">terminal</span> Copy as cURL (bash)</a>
                                <a href="#" onclick="copyDatabasesCurlCmd()"><span class="material-symbols-outlined">terminal</span> Copy as cURL (cmd)</a>
                                <a href="#" onclick="copyDatabasesCurlPowerShell()"><span class="material-symbols-outlined">terminal</span> Copy as PowerShell</a>
                            </div>
                        </div>
                    </div>
                    <div id="databases-pretty-view" class="chart-wrapper active" style="display: none;">
                        <div class="databases-pretty-container" id="databases-pretty-content"></div>
                    </div>
                </div>
            </div>

            <!-- Flows Tab -->
            <div id="flows-tab" class="tab-content">
                <div class="section">
                    <h2>List Data Flows</h2>
                    <div class="form-group">
                        <label for="flows-source">Source ID:</label>
                        <input type="text" id="flows-source" list="sources-list" placeholder="e.g., ECB">
                    </div>
                    <div class="form-group">
                        <label for="flows-database">Database (optional):</label>
                        <input type="text" id="flows-database" list="databases-list-flows" placeholder="Leave empty for default">
                    </div>
                    <div class="button-group">
                        <button onclick="getFlows()">Get Flows</button>
                        <div class="dropdown" id="flows-copy-dropdown" style="display: none;">
                            <button class="dropdown-button" onclick="toggleFlowsCopyDropdown()">
                                <span class="material-symbols-outlined">content_copy</span> Copy <span class="dropdown-arrow"></span>
                            </button>
                            <div class="dropdown-content" id="flows-copy-dropdown-content">
                                <a href="#" onclick="copyFlowsJSON()"><span class="material-symbols-outlined">code</span> Copy JSON</a>
                                <a href="#" onclick="copyFlowsCurlBash()"><span class="material-symbols-outlined">terminal</span> Copy as cURL (bash)</a>
                                <a href="#" onclick="copyFlowsCurlCmd()"><span class="material-symbols-outlined">terminal</span> Copy as cURL (cmd)</a>
                                <a href="#" onclick="copyFlowsCurlPowerShell()"><span class="material-symbols-outlined">terminal</span> Copy as PowerShell</a>
                            </div>
                        </div>
                    </div>

                    <div id="flows-pretty-view" class="chart-wrapper active" style="display: none;">
                        <div class="flows-pretty-container" id="flows-pretty-content"></div>
                    </div>
                </div>
            </div>

            <!-- Flow Search Tab -->
            <div id="flowsearch-tab" class="tab-content">
                <div class="section">
                    <h2><span class="material-symbols-outlined">travel_explore</span> Search Flows Across All Sources</h2>

                    <!-- Google-like search interface -->
                    <div style="max-width: 800px; margin: 40px auto; text-align: center;">
                        <!-- Search Box -->
                        <div style="position: relative; margin-bottom: 30px;">
                            <div style="display: flex; align-items: center; border: 1px solid #dfe1e5; border-radius: 24px; padding: 10px 20px; box-shadow: 0 1px 6px rgba(32,33,36,.28); transition: box-shadow 0.2s;">
                                <span class="material-symbols-outlined" style="color: #9aa0a6; margin-right: 12px;">search</span>
                                <input
                                    type="text"
                                    id="flowsearch-input"
                                    placeholder="Search for flows..."
                                    style="flex: 1; border: none; outline: none; font-size: 16px; padding: 5px 0;"
                                    onkeypress="if(event.key === 'Enter') performFlowSearch()"
                                    oninput="debouncedFlowSearch()"
                                >
                                <button
                                    id="flowsearch-clear-btn"
                                    onclick="clearFlowSearch()"
                                    style="display: none; background: none; border: none; padding: 0; margin-left: 8px; cursor: pointer; color: #9aa0a6;"
                                    title="Clear">
                                    <span class="material-symbols-outlined">close</span>
                                </button>
                            </div>

                            <!-- Search Options -->
                            <div style="margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 10px; font-size: 13px; color: #666;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="flowsearch-case-check" style="margin-right: 5px;">
                                    Match case
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="flowsearch-words-check" style="margin-right: 5px;">
                                    Whole words
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="flowsearch-regex-check" style="margin-right: 5px;">
                                    Use regex
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="flowsearch-fuzzy-check" style="margin-right: 5px;">
                                    Fuzzy search
                                </label>
                            </div>

                            <!-- Recent Searches -->
                            <div id="recent-searches-container" style="display: none;"></div>
                        </div>


                        <!-- Index Status & Actions -->
                        <div id="index-status-container" style="margin-bottom: 20px;">
                            <div id="index-status-text" style="color: #666; margin-bottom: 10px;"></div>
                            <!-- Progress bar -->
                            <div id="index-progress-container" style="display: none; margin-bottom: 15px;">
                                <div style="background: #e0e0e0; height: 6px; border-radius: 3px; overflow: hidden;">
                                    <div id="index-progress-bar" style="background: linear-gradient(90deg, #1a73e8 0%, #4285f4 100%); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                                </div>
                                <div id="index-progress-text" style="font-size: 12px; color: #666; margin-top: 5px; text-align: center;"></div>
                            </div>
                            <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                                <button
                                    onclick="indexAllFlows()"
                                    id="index-flows-btn"
                                    style="padding: 8px 16px; background: #1a73e8; border: 1px solid #1a73e8; border-radius: 4px; color: white; font-size: 13px; cursor: pointer; transition: all 0.2s;"
                                    onmouseover="this.style.background='#1557b0';"
                                    onmouseout="this.style.background='#1a73e8';">
                                    <span class="material-symbols-outlined" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">cloud_download</span>
                                    Index All Flows
                                </button>
                                <button
                                    onclick="clearFlowsCache()"
                                    style="padding: 8px 16px; background: #f8f9fa; border: 1px solid #dadce0; border-radius: 4px; color: #3c4043; font-size: 13px; cursor: pointer; transition: all 0.2s;"
                                    onmouseover="this.style.background='#e8eaed';"
                                    onmouseout="this.style.background='#f8f9fa';">
                                    <span class="material-symbols-outlined" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">delete_sweep</span>
                                    Clear Cache
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div id="flowsearch-results-container" style="display: none;">
                        <!-- Results info -->
                        <div style="padding: 10px 20px; border-bottom: 1px solid #e0e0e0; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;">
                            <div id="flowsearch-results-info" style="color: #70757a; font-size: 14px;">
                                <!-- Will show "About X results (Y seconds)" -->
                            </div>
                            <button
                                onclick="exportFlowSearchResults()"
                                style="padding: 6px 12px; background: #f8f9fa; border: 1px solid #dadce0; border-radius: 4px; color: #3c4043; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 4px;"
                                title="Export results">
                                <span class="material-symbols-outlined" style="font-size: 18px;">download</span>
                                Export
                            </button>
                        </div>

                        <!-- Results list -->
                        <div id="flowsearch-results" class="flows-pretty-container">
                            <!-- Search results will be displayed here -->
                        </div>
                    </div>

                    <!-- Empty state / No results -->
                    <div id="flowsearch-empty-state" style="display: none; text-align: center; padding: 60px 20px; color: #666; max-width: 600px; margin: 0 auto;">
                        <span class="material-symbols-outlined" style="font-size: 64px; color: #dadce0; margin-bottom: 20px;">search_off</span>
                        <h3 style="color: #3c4043; margin-bottom: 10px;">No flows found</h3>
                        <p style="margin-bottom: 20px;">Your search didn't match any flows. Try:</p>
                        <ul style="text-align: left; display: inline-block; margin: 0 auto 20px; color: #5f6368;">
                            <li style="margin-bottom: 8px;">Using different keywords</li>
                            <li style="margin-bottom: 8px;">Checking your spelling</li>
                            <li style="margin-bottom: 8px;">Disabling search options (fuzzy, regex, etc.)</li>
                            <li style="margin-bottom: 8px;">Searching for flow IDs or source names</li>
                        </ul>
                        <p style="font-size: 13px; color: #80868b;">
                            <strong>Tip:</strong> Search for "exchange rate", "GDP", or a source like "ECB" to find flows
                        </p>
                    </div>
                </div>
            </div>

            <!-- Meta Tab -->
            <div id="meta-tab" class="tab-content">
                <div class="section">
                    <h2>Get Meta</h2>
                    <div class="form-group">
                        <label for="meta-source">Source ID:</label>
                        <input type="text" id="meta-source" list="sources-list" placeholder="e.g., ECB">
                    </div>
                    <div class="form-group">
                        <label for="meta-flow">Flow ID:</label>
                        <input type="text" id="meta-flow" list="flows-list-meta" placeholder="e.g., EXR">
                    </div>
                    <div class="form-group">
                        <label for="meta-database">Database (optional):</label>
                        <input type="text" id="meta-database" list="databases-list-meta" placeholder="Leave empty for default">
                    </div>
                    <div class="button-group">
                        <button onclick="getMeta()">Get Meta</button>
                        <div class="dropdown" id="meta-copy-dropdown" style="display: none;">
                            <button class="dropdown-button" onclick="toggleMetaCopyDropdown()">
                                <span class="material-symbols-outlined">content_copy</span> Copy <span class="dropdown-arrow"></span>
                            </button>
                            <div class="dropdown-content" id="meta-copy-dropdown-content">
                                <a href="#" onclick="copyMetaJSON()"><span class="material-symbols-outlined">code</span> Copy JSON</a>
                                <a href="#" onclick="copyMetaCurlBash()"><span class="material-symbols-outlined">terminal</span> Copy as cURL (bash)</a>
                                <a href="#" onclick="copyMetaCurlCmd()"><span class="material-symbols-outlined">terminal</span> Copy as cURL (cmd)</a>
                                <a href="#" onclick="copyMetaCurlPowerShell()"><span class="material-symbols-outlined">terminal</span> Copy as PowerShell</a>
                            </div>
                        </div>
                    </div>

                    <div id="meta-pretty-view" class="chart-wrapper active" style="display: none;">
                        <div class="meta-pretty-container" id="meta-pretty-content"></div>
                    </div>
                </div>
            </div>

            <!-- Key Builder Tab -->
            <div id="keybuilder-tab" class="tab-content">
                <div class="section">
                    <h2><span class="material-symbols-outlined">vpn_key</span> SDMX Key Builder</h2>
                    <p style="margin-bottom: 15px; color: #666;">Build a valid SDMX key by selecting values for each dimension</p>

                    <div class="form-group">
                        <label for="kb-source">Source ID:</label>
                        <input type="text" id="kb-source" list="sources-list" placeholder="e.g., ECB">
                    </div>
                    <div class="form-group">
                        <label for="kb-flow">Flow ID:</label>
                        <input type="text" id="kb-flow" list="flows-list-kb" placeholder="e.g., EXR">
                    </div>
                    <div class="form-group">
                        <label for="kb-database">Database (optional):</label>
                        <input type="text" id="kb-database" list="databases-list-kb" placeholder="Leave empty for default">
                    </div>
                    <button onclick="loadKeyBuilderStructure()">Load Structure</button>

                    <div class="key-input-mode-toggle" id="key-input-mode-toggle" style="display: none;">
                        <button class="active" onclick="switchKeyInputMode('guided')"><span class="material-symbols-outlined">track_changes</span> Guided Mode</button>
                        <button onclick="switchKeyInputMode('quick')"><span class="material-symbols-outlined">bolt</span> Quick Input</button>
                        <button onclick="switchKeyInputMode('hierarchy')"><span class="material-symbols-outlined">device_hub</span> Hierarchy View</button>
                    </div>

                    <div id="quick-key-container" style="display: none;">
                        <div class="quick-key-input-container">
                            <h3>Quick Key Input</h3>
                            <div class="quick-key-wrapper">
                                <input
                                    type="text"
                                    id="quick-key-input"
                                    class="quick-key-input"
                                    placeholder="Type key with dots (e.g., M.USD.EUR.SP00.A)"
                                    autocomplete="off"
                                />
                                <div id="autocomplete-dropdown" class="autocomplete-dropdown"></div>
                            </div>
                            <div class="quick-key-hint">
                                <span class="material-symbols-outlined">lightbulb</span> <strong>Tip:</strong> Type your key using dots as separators. Autocomplete will suggest available codes as you type.
                                Use arrow keys to navigate and Enter to select. Press Tab or Dot to move to the next dimension.
                            </div>
                        </div>
                    </div>


                    <div id="hierarchy-key-container" style="display: none;">
                        <div class="hierarchy-key-builder-container">
                            <h3><span class="material-symbols-outlined">device_hub</span> Hierarchical Tree View</h3>
                            <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Explore code hierarchies and drill down to select specific values</p>
                            <div id="hierarchy-builder-content" class="hierarchy-builder-content"></div>
                        </div>
                    </div>

                    <div id="dimensions-container" style="display: none;">
                        <div class="key-builder-container">
                            <h3>Select Dimension Values</h3>
                            <div id="dimensions-list"></div>
                        </div>
                    </div>

                    <div class="built-key-container" id="built-key-container" style="display: none;">
                        <h3>Generated SDMX Key</h3>
                        <div class="built-key" id="generated-key">-</div>
                        <div class="key-actions" id="key-actions">
                            <!-- Buttons will be dynamically rendered based on callback URL presence -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Tab -->
            <div id="data-tab" class="tab-content">
                <div class="section">
                    <h2>Get Data</h2>
                    <div class="form-group">
                        <label for="data-source">Source ID:</label>
                        <input type="text" id="data-source" list="sources-list" placeholder="e.g., ECB">
                    </div>
                    <div class="form-group">
                        <label for="data-flow">Flow ID:</label>
                        <input type="text" id="data-flow" list="flows-list-data" placeholder="e.g., EXR">
                    </div>
                    <div class="form-group">
                        <label for="data-key">Key:</label>
                        <input type="text" id="data-key" placeholder="e.g., M.USD+CHF.EUR.SP00.A">
                    </div>
                    <div class="form-group">
                        <label for="data-database">Database (optional):</label>
                        <input type="text" id="data-database" list="databases-list-data" placeholder="Leave empty for default">
                    </div>
                    <div class="button-group">
                        <button onclick="getData()">Get Data</button>
                        <div class="dropdown" id="data-copy-dropdown" style="display: none;">
                            <button class="dropdown-button" onclick="toggleDataCopyDropdown()">
                                <span class="material-symbols-outlined">content_copy</span> Copy <span class="dropdown-arrow"></span>
                            </button>
                            <div class="dropdown-content" id="data-copy-dropdown-content">
                                <a href="#" onclick="copyDataJSON()"><span class="material-symbols-outlined">code</span> Copy JSON</a>
                                <a href="#" onclick="copyDataCurlBash()"><span class="material-symbols-outlined">terminal</span> Copy as cURL (bash)</a>
                                <a href="#" onclick="copyDataCurlCmd()"><span class="material-symbols-outlined">terminal</span> Copy as cURL (cmd)</a>
                                <a href="#" onclick="copyDataCurlPowerShell()"><span class="material-symbols-outlined">terminal</span> Copy as PowerShell</a>
                            </div>
                        </div>
                    </div>

                    <div id="data-pretty-view" class="chart-wrapper active" style="display: none;">
                        <div class="chart-container">
                            <div id="data-chart"></div>
                        </div>
                        <div class="table-container" style="margin-top: 30px;">
                            <div id="table-content"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Compare Tab -->
            <div id="compare-tab" class="tab-content">
                <div class="section">
                    <h2><span class="material-symbols-outlined">compare_arrows</span> Compare Time Series</h2>
                    <p style="margin-bottom: 20px; color: #666;">Add multiple data series to compare them visually on the same chart</p>

                    <div id="compare-series-list" style="margin-bottom: 20px;">
                        <!-- Series items will be added here dynamically -->
                    </div>

                    <div style="background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; color: #003D6D; font-size: 1.1em;">Add New Series</h3>
                        <div class="form-group">
                            <label for="compare-source">Source ID:</label>
                            <input type="text" id="compare-source" list="sources-list" placeholder="e.g., ECB">
                        </div>
                        <div class="form-group">
                            <label for="compare-flow">Flow ID:</label>
                            <input type="text" id="compare-flow" list="flows-list-compare" placeholder="e.g., EXR">
                        </div>
                        <div class="form-group">
                            <label for="compare-key">Key:</label>
                            <input type="text" id="compare-key" placeholder="e.g., M.USD.EUR.SP00.A">
                        </div>
                        <div class="form-group">
                            <label for="compare-database">Database (optional):</label>
                            <input type="text" id="compare-database" list="databases-list-compare" placeholder="Leave empty for default">
                        </div>
                        <div class="form-group">
                            <label for="compare-label">Series Label (optional):</label>
                            <input type="text" id="compare-label" placeholder="Custom label for this series">
                        </div>
                        <button onclick="addSeriesToComparison()" style="width: 100%;">
                            <span class="material-symbols-outlined">add</span> Add Series
                        </button>
                    </div>

                    <div class="button-group" style="margin-bottom: 20px;">
                        <button onclick="compareAllSeries()" id="compare-btn" disabled>
                            <span class="material-symbols-outlined">show_chart</span> Compare Series
                        </button>
                        <button onclick="clearAllSeries()" style="background: #dc3545; border-color: #dc3545;">
                            <span class="material-symbols-outlined">delete</span> Clear All
                        </button>
                    </div>

                    <div id="compare-chart-wrapper" style="display: none;">
                        <div class="chart-container">
                            <div id="compare-chart"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Datalists for autocompletion -->
            <datalist id="sources-list"></datalist>
            <datalist id="databases-list-flows"></datalist>
            <datalist id="databases-list-meta"></datalist>
            <datalist id="databases-list-data"></datalist>
            <datalist id="databases-list-kb"></datalist>
            <datalist id="databases-list-compare"></datalist>
            <datalist id="flows-list-meta"></datalist>
            <datalist id="flows-list-data"></datalist>
            <datalist id="flows-list-kb"></datalist>
            <datalist id="flows-list-compare"></datalist>
        </div>
    </div>

    <!-- View Control Buttons -->
    <div class="view-controls">
        <button class="view-toggle-btn" id="help-btn" onclick="showUrlParamsHelp()" title="URL Parameters Help">
            <span class="material-symbols-outlined">help</span>
        </button>
        <button class="view-toggle-btn" id="view-menu-btn" onclick="toggleViewMenu()" title="View Options">
            <span class="material-symbols-outlined">visibility</span>
        </button>
        <div class="view-menu" id="view-menu" style="display: none;">
            <button class="view-menu-item" id="toggle-header-btn" onclick="toggleHeader(); event.stopPropagation();">
                <span class="material-symbols-outlined">view_headline</span>
                <span>Toggle Header</span>
            </button>
            <button class="view-menu-item" id="toggle-tabs-btn" onclick="toggleOtherTabs(); event.stopPropagation();">
                <span class="material-symbols-outlined">tab</span>
                <span>Toggle Other Tabs</span>
            </button>
        </div>
    </div>

    <!-- URL Parameters Help Modal -->
    <div id="url-params-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2><span class="material-symbols-outlined">help</span> URL Parameters Documentation</h2>
                <button class="modal-close" onclick="closeUrlParamsHelp()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="help-section">
                    <h3>Tab Selection</h3>
                    <table class="help-table">
                        <tr>
                            <td class="param-name">tab</td>
                            <td class="param-desc">Select active tab</td>
                            <td class="param-example">?tab=keybuilder</td>
                        </tr>
                    </table>
                    <p class="help-note">Values: sources, databases, flows, flowsearch, meta, keybuilder, data, compare</p>
                </div>

                <div class="help-section">
                    <h3>View Controls</h3>
                    <table class="help-table">
                        <tr>
                            <td class="param-name">hideHeader</td>
                            <td class="param-desc">Hide the header section</td>
                            <td class="param-example">?hideHeader=true</td>
                        </tr>
                        <tr>
                            <td class="param-name">hideOtherTabs</td>
                            <td class="param-desc">Hide non-selected tabs</td>
                            <td class="param-example">?hideOtherTabs=true</td>
                        </tr>
                    </table>
                </div>

                <div class="help-section">
                    <h3>Key Builder Integration</h3>
                    <table class="help-table">
                        <tr>
                            <td class="param-name">callback</td>
                            <td class="param-desc">URL to send key data via POST</td>
                            <td class="param-example">?callback=http://example.com/api/keys</td>
                        </tr>
                    </table>
                    <p class="help-note">When callback is set, Key Builder shows a "Send" button instead of regular buttons. Sends JSON: <code>{ source, flow, database, key }</code></p>
                </div>

                <div class="help-section">
                    <h3>Form Pre-filling</h3>
                    <table class="help-table">
                        <tr>
                            <td class="param-name">source</td>
                            <td class="param-desc">Pre-fill source ID</td>
                            <td class="param-example">?source=ECB</td>
                        </tr>
                        <tr>
                            <td class="param-name">flow</td>
                            <td class="param-desc">Pre-fill flow ID</td>
                            <td class="param-example">?flow=EXR</td>
                        </tr>
                        <tr>
                            <td class="param-name">database</td>
                            <td class="param-desc">Pre-fill database</td>
                            <td class="param-example">?database=mydb</td>
                        </tr>
                        <tr>
                            <td class="param-name">key</td>
                            <td class="param-desc">Pre-fill SDMX key</td>
                            <td class="param-example">?key=M.USD.EUR.SP00.A</td>
                        </tr>
                    </table>
                    <p class="help-note">Parameters are applied to the selected tab. Use with <code>tab</code> parameter for best results.</p>
                </div>

                <div class="help-section">
                    <h3>Complete Examples</h3>
                    <div class="help-example">
                        <strong>Open Key Builder with callback:</strong>
                        <code>?tab=keybuilder&callback=http://myapp.com/api&source=ECB&flow=EXR</code>
                    </div>
                    <div class="help-example">
                        <strong>Open Data tab with pre-filled values:</strong>
                        <code>?tab=data&source=ECB&flow=EXR&key=M.USD.EUR.SP00.A</code>
                    </div>
                    <div class="help-example">
                        <strong>Minimal UI for embedding:</strong>
                        <code>?tab=keybuilder&hideHeader=true&hideOtherTabs=true</code>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/sdmx-dl';

        // ========================================================================
        // UTILITY FUNCTIONS
        // ========================================================================

        /**
         * Escape HTML special characters to prevent XSS
         * @param {string} text - Text to escape
         * @returns {string} - Escaped text
         */
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========================================================================
        // VIEW CONTROL FUNCTIONS
        // ========================================================================

        /**
         * Toggle view menu visibility
         */
        function toggleViewMenu() {
            const menu = document.getElementById('view-menu');
            const isVisible = menu.style.display !== 'none';

            if (isVisible) {
                menu.style.display = 'none';
            } else {
                menu.style.display = 'block';
            }
        }

        /**
         * Show URL parameters help modal
         */
        function showUrlParamsHelp() {
            const modal = document.getElementById('url-params-modal');
            if (modal) {
                modal.style.display = 'flex';
                // Close view menu if open
                const viewMenu = document.getElementById('view-menu');
                if (viewMenu) {
                    viewMenu.style.display = 'none';
                }
            }
        }

        /**
         * Close URL parameters help modal
         */
        function closeUrlParamsHelp() {
            const modal = document.getElementById('url-params-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        /**
         * Toggle header visibility
         */
        function toggleHeader() {
            const container = document.querySelector('.container');
            const button = document.getElementById('toggle-header-btn');
            const url = new URL(window.location);

            if (container.classList.contains('hide-header')) {
                // Show header
                container.classList.remove('hide-header');
                button.classList.remove('active');
                url.searchParams.delete('hideHeader');
            } else {
                // Hide header
                container.classList.add('hide-header');
                button.classList.add('active');
                url.searchParams.set('hideHeader', 'true');
            }

            // Update URL without page reload
            window.history.pushState({}, '', url);
        }

        /**
         * Toggle other tabs visibility
         */
        function toggleOtherTabs() {
            const tabsContainer = document.querySelector('.tabs');
            const button = document.getElementById('toggle-tabs-btn');
            const url = new URL(window.location);

            if (tabsContainer.classList.contains('hide-others')) {
                // Show all tabs
                tabsContainer.classList.remove('hide-others');
                button.classList.remove('active');
                url.searchParams.delete('hideOtherTabs');
            } else {
                // Hide other tabs
                tabsContainer.classList.add('hide-others');
                button.classList.add('active');
                url.searchParams.set('hideOtherTabs', 'true');
            }

            // Update URL without page reload
            window.history.pushState({}, '', url);
        }

        /**
         * Initialize button states based on current URL parameters
         */
        function initializeViewControls() {
            const urlParams = new URLSearchParams(window.location.search);
            const hideHeader = urlParams.get('hideHeader') === 'true';
            const hideOtherTabs = urlParams.get('hideOtherTabs') === 'true';

            const headerBtn = document.getElementById('toggle-header-btn');
            const tabsBtn = document.getElementById('toggle-tabs-btn');

            if (hideHeader && headerBtn) {
                headerBtn.classList.add('active');
            }

            if (hideOtherTabs && tabsBtn) {
                tabsBtn.classList.add('active');
            }
        }

        /**
         * Generic dropdown toggle utility
         * @param {string} dropdownId - ID of the dropdown element
         */
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (dropdown) {
                dropdown.classList.toggle('open');
            }
        }

        /**
         * Generic view switcher utility
         * @param {string} prefix - Prefix for view IDs (e.g., 'sources', 'flows')
         * @param {string} view - View name (e.g., 'json', 'pretty', 'chart')
         * @param {Array<string>} viewNames - Array of all possible view names
         */
        function switchView(prefix, view, viewNames) {
            // Hide all views
            viewNames.forEach(viewName => {
                const element = document.getElementById(`${prefix}-${viewName}`);
                if (element) {
                    element.style.display = 'none';
                }
            });

            // Show selected view
            const selectedView = document.getElementById(`${prefix}-${view}`);
            if (selectedView) {
                selectedView.style.display = 'block';
            }

            // Close dropdown if exists
            const dropdown = document.getElementById(`${prefix}-view-dropdown`);
            if (dropdown) {
                dropdown.classList.remove('open');
            }
        }

        /**
         * Update dropdown button text and active state
         * @param {string} dropdownId - ID of the dropdown
         * @param {string} view - Current view name
         * @param {Object} viewConfig - Configuration object mapping view names to display text and icons
         */
        function updateDropdownActive(dropdownId, view, viewConfig) {
            const dropdownButton = document.querySelector(`#${dropdownId} .dropdown-button`);
            // Handle both patterns: "xxx-view-dropdown" -> "xxx-dropdown-content" or direct ID mapping
            const contentId = dropdownId.replace('-view-dropdown', '-dropdown-content');
            const dropdownItems = document.querySelectorAll(`#${contentId} a`);

            if (dropdownButton && viewConfig[view]) {
                const config = viewConfig[view];
                dropdownButton.innerHTML = `<span class="material-symbols-outlined">${config.icon}</span> ${config.label} <span class="dropdown-arrow"></span>`;
            }

            // Update active states
            dropdownItems.forEach(item => {
                item.classList.remove('active');
                Object.keys(viewConfig).forEach(viewName => {
                    if (item.onclick && item.onclick.toString().includes(`'${viewName}'`)) {
                        if (viewName === view) {
                            item.classList.add('active');
                        }
                    }
                });
            });
        }

        /**
         * Fetch API helper with error handling
         * @param {string} endpoint - API endpoint
         * @param {Object} body - Request body
         * @returns {Promise<Object>} - Response JSON
         */
        async function fetchAPI(endpoint, body) {
            const response = await fetch(API_BASE + endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
            }

            return response.json();
        }

        /**
         * Display error in response container
         * @param {string} containerId - ID of the container element
         * @param {string} contentId - ID of the content element
         * @param {string} message - Error message
         */
        function displayError(containerId, contentId, message) {
            const container = document.getElementById(containerId);
            const content = document.getElementById(contentId);
            if (container && content) {
                container.style.display = 'block';
                container.classList.remove('success');
                container.classList.add('error');
                content.textContent = `Error: ${message}`;
            }
        }

        /**
         * Display success in response container
         * @param {string} containerId - ID of the container element
         * @param {string} contentId - ID of the content element
         * @param {Object} data - Response data
         */
        function displaySuccess(containerId, contentId, data) {
            const container = document.getElementById(containerId);
            const content = document.getElementById(contentId);
            if (container && content) {
                container.style.display = 'block';
                container.classList.remove('error');
                container.classList.add('success');
                content.textContent = JSON.stringify(data, null, 2);
            }
        }

        /**
         * Calculate Levenshtein distance (edit distance) between two strings
         * Used for fuzzy matching
         * @param {string} str1 - First string
         * @param {string} str2 - Second string
         * @returns {number} - Edit distance
         */
        function levenshteinDistance(str1, str2) {
            const len1 = str1.length;
            const len2 = str2.length;
            const matrix = Array(len1 + 1).fill(null).map(() => Array(len2 + 1).fill(0));

            for (let i = 0; i <= len1; i++) matrix[i][0] = i;
            for (let j = 0; j <= len2; j++) matrix[0][j] = j;

            for (let i = 1; i <= len1; i++) {
                for (let j = 1; j <= len2; j++) {
                    const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j] + 1,      // deletion
                        matrix[i][j - 1] + 1,      // insertion
                        matrix[i - 1][j - 1] + cost // substitution
                    );
                }
            }

            return matrix[len1][len2];
        }

        /**
         * Fuzzy match - checks if query fuzzy matches text
         * @param {string} text - Text to search in
         * @param {string} query - Search query
         * @param {number} threshold - Maximum edit distance (default: 2)
         * @returns {boolean} - Whether text fuzzy matches query
         */
        function fuzzyMatch(text, query, threshold = 2) {
            if (!query) return true;

            text = text.toLowerCase();
            query = query.toLowerCase();

            // Exact match
            if (text.includes(query)) return true;

            // Check if query fuzzy matches any word in text
            const words = text.split(/\s+/);
            for (const word of words) {
                // For short queries, use stricter threshold
                const adjustedThreshold = query.length <= 3 ? 1 : threshold;

                // Check full word match
                if (levenshteinDistance(word, query) <= adjustedThreshold) {
                    return true;
                }

                // Check if query is substring with typos
                if (word.length >= query.length) {
                    for (let i = 0; i <= word.length - query.length; i++) {
                        const substring = word.substring(i, i + query.length);
                        if (levenshteinDistance(substring, query) <= adjustedThreshold) {
                            return true;
                        }
                    }
                }
            }

            return false;
        }

        /**
         * Generic filter matcher utility
         * @param {string} text - Text to search in
         * @param {string} query - Search query
         * @param {Object} options - Filter options
         * @returns {boolean} - Whether text matches query
         */
        function matchesFilter(text, query, options = {}) {
            const { matchCase = false, wholeWords = false, isRegex = false, isFuzzy = false } = options;

            if (!query) return true;

            const searchText = matchCase ? text : text.toLowerCase();
            const searchQuery = matchCase ? query : query.toLowerCase();

            if (isFuzzy) {
                return fuzzyMatch(searchText, searchQuery);
            } else if (isRegex) {
                try {
                    const regex = new RegExp(searchQuery, matchCase ? '' : 'i');
                    return regex.test(searchText);
                } catch (e) {
                    // Invalid regex, fall back to substring
                    return searchText.includes(searchQuery);
                }
            } else if (wholeWords) {
                const escapedQuery = searchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp('\\b' + escapedQuery + '\\b', matchCase ? '' : 'i');
                return regex.test(searchText);
            } else {
                return searchText.includes(searchQuery);
            }
        }

        /**
         * Generic filter setup utility for card-based views
         * @param {Object} config - Filter configuration
         */
        function setupCardFilter(config) {
            const {
                filterInputId,
                filterCountId,
                clearBtnId,
                matchCaseBtnId,
                wholeWordsBtnId,
                regexBtnId,
                fuzzyBtnId,
                cardSelector,
                filterTextAttr = 'data-filter-text',
                itemName = 'items'
            } = config;

            const filterInput = document.getElementById(filterInputId);
            const filterCount = document.getElementById(filterCountId);
            const clearBtn = document.getElementById(clearBtnId);
            const matchCaseBtn = document.getElementById(matchCaseBtnId);
            const wholeWordsBtn = document.getElementById(wholeWordsBtnId);
            const regexBtn = document.getElementById(regexBtnId);
            const fuzzyBtn = document.getElementById(fuzzyBtnId);

            if (!filterInput) return;

            function performFilter() {
                const query = filterInput.value.trim();
                const cards = document.querySelectorAll(cardSelector);

                if (!query) {
                    cards.forEach(card => card.classList.remove('filtered-hidden'));
                    if (filterCount) {
                        filterCount.textContent = `${cards.length} ${itemName}`;
                    }
                    return;
                }

                let visibleCount = 0;
                const options = {
                    matchCase: matchCaseBtn?.classList.contains('active'),
                    wholeWords: wholeWordsBtn?.classList.contains('active'),
                    isRegex: regexBtn?.classList.contains('active'),
                    isFuzzy: fuzzyBtn?.classList.contains('active')
                };

                cards.forEach(card => {
                    const filterText = card.getAttribute(filterTextAttr);
                    const matches = matchesFilter(filterText, query, options);

                    if (matches) {
                        card.classList.remove('filtered-hidden');
                        visibleCount++;
                    } else {
                        card.classList.add('filtered-hidden');
                    }
                });

                if (filterCount) {
                    filterCount.textContent = `${visibleCount} of ${cards.length}`;
                }
            }

            // Attach event listeners
            filterInput.addEventListener('input', performFilter);

            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    filterInput.value = '';
                    performFilter();
                });
            }

            [matchCaseBtn, wholeWordsBtn, regexBtn, fuzzyBtn].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', function() {
                        this.classList.toggle('active');
                        performFilter();
                    });
                }
            });

            return performFilter;
        }

        // ========================================================================
        // TAB NAVIGATION
        // ========================================================================

        /**
         * Switch to a tab and update URL with current form values
         * @param {string} tabName - Name of the tab to switch to
         * @param {boolean} fromUrl - True if called from URL parameter loading
         */
        function switchTab(tabName, fromUrl = false) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            const tabContent = document.getElementById(tabName + '-tab');
            if (tabContent) {
                tabContent.classList.add('active');
            }

            // Activate the corresponding tab button
            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(btn => {
                const btnOnClick = btn.getAttribute('onclick');
                if (btnOnClick && btnOnClick.includes(`'${tabName}'`)) {
                    btn.classList.add('active');
                }
            });

            // Check if we should hide other tabs
            const urlParams = new URLSearchParams(window.location.search);
            const hideOtherTabs = urlParams.get('hideOtherTabs') === 'true';
            const tabsContainer = document.querySelector('.tabs');
            if (tabsContainer) {
                if (hideOtherTabs) {
                    tabsContainer.classList.add('hide-others');
                } else {
                    tabsContainer.classList.remove('hide-others');
                }
            }

            // Check if we should hide the header
            const hideHeader = urlParams.get('hideHeader') === 'true';
            const container = document.querySelector('.container');
            if (container) {
                if (hideHeader) {
                    container.classList.add('hide-header');
                } else {
                    container.classList.remove('hide-header');
                }
            }

            // Update URL if not loading from URL
            if (!fromUrl) {
                updateUrlFromForm(tabName);
            }
        }

        /**
         * Update URL query parameters based on current tab's form values
         * @param {string} tabName - Current active tab name
         */
        function updateUrlFromForm(tabName) {
            const url = new URL(window.location);

            // Preserve hideOtherTabs, hideHeader and callback parameters if they exist
            const hideOtherTabs = url.searchParams.get('hideOtherTabs');
            const hideHeader = url.searchParams.get('hideHeader');
            const callback = url.searchParams.get('callback');

            // Clear all existing parameters
            url.search = '';

            // Always add the tab parameter
            url.searchParams.set('tab', tabName);

            // Restore hideOtherTabs parameter if it was set
            if (hideOtherTabs === 'true') {
                url.searchParams.set('hideOtherTabs', 'true');
            }

            // Restore hideHeader parameter if it was set
            if (hideHeader === 'true') {
                url.searchParams.set('hideHeader', 'true');
            }

            // Restore callback parameter if it was set
            if (callback) {
                url.searchParams.set('callback', callback);
            }

            // Add form field values for the current tab with simplified param names
            const formFieldsMap = getFormFieldsForTab(tabName);
            formFieldsMap.forEach(mapping => {
                const element = document.getElementById(mapping.fieldId);
                if (element && element.value.trim()) {
                    url.searchParams.set(mapping.paramName, element.value.trim());
                }
            });

            // Update URL without page reload
            window.history.pushState({ tab: tabName }, '', url);
        }

        /**
         * Get list of form field mappings for a specific tab
         * @param {string} tabName - Tab name
         * @returns {Array<{fieldId: string, paramName: string}>} - Array of field mappings
         */
        function getFormFieldsForTab(tabName) {
            const fieldsByTab = {
                'databases': [
                    { fieldId: 'db-source', paramName: 'source' }
                ],
                'flows': [
                    { fieldId: 'flows-source', paramName: 'source' },
                    { fieldId: 'flows-database', paramName: 'database' }
                ],
                'meta': [
                    { fieldId: 'meta-source', paramName: 'source' },
                    { fieldId: 'meta-flow', paramName: 'flow' },
                    { fieldId: 'meta-database', paramName: 'database' }
                ],
                'keybuilder': [
                    { fieldId: 'kb-source', paramName: 'source' },
                    { fieldId: 'kb-flow', paramName: 'flow' },
                    { fieldId: 'kb-database', paramName: 'database' }
                ],
                'data': [
                    { fieldId: 'data-source', paramName: 'source' },
                    { fieldId: 'data-flow', paramName: 'flow' },
                    { fieldId: 'data-key', paramName: 'key' },
                    { fieldId: 'data-database', paramName: 'database' }
                ],
                'compare': [
                    { fieldId: 'compare-source', paramName: 'source' },
                    { fieldId: 'compare-flow', paramName: 'flow' },
                    { fieldId: 'compare-key', paramName: 'key' },
                    { fieldId: 'compare-database', paramName: 'database' },
                    { fieldId: 'compare-label', paramName: 'label' }
                ]
            };

            return fieldsByTab[tabName] || [];
        }

        /**
         * Load form values from URL parameters
         */
        function loadFormFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const tab = urlParams.get('tab');
            const hideOtherTabs = urlParams.get('hideOtherTabs') === 'true';
            const hideHeader = urlParams.get('hideHeader') === 'true';

            // Apply hideOtherTabs setting even if no tab specified
            const tabsContainer = document.querySelector('.tabs');
            if (tabsContainer) {
                if (hideOtherTabs) {
                    tabsContainer.classList.add('hide-others');
                } else {
                    tabsContainer.classList.remove('hide-others');
                }
            }

            // Apply hideHeader setting
            const container = document.querySelector('.container');
            if (container) {
                if (hideHeader) {
                    container.classList.add('hide-header');
                } else {
                    container.classList.remove('hide-header');
                }
            }

            // If no tab parameter, don't do anything more (use default tab)
            if (!tab) {
                return;
            }

            // Validate tab exists
            const tabContent = document.getElementById(tab + '-tab');
            if (!tabContent) {
                console.warn(`Tab '${tab}' not found, ignoring URL parameters`);
                return;
            }

            // Get form field mappings for this tab
            const formFieldsMap = getFormFieldsForTab(tab);

            // Fill form fields from URL parameters
            formFieldsMap.forEach(mapping => {
                const value = urlParams.get(mapping.paramName);
                if (value) {
                    const element = document.getElementById(mapping.fieldId);
                    if (element) {
                        element.value = value;
                    }
                }
            });

            // Switch to the tab (without updating URL to avoid circular update)
            switchTab(tab, true);
        }

        /**
         * Add change listeners to form fields to update URL
         */
        function setupFormUrlSync() {
            // Get all form input fields
            const allFields = [
                'db-source',
                'flows-source', 'flows-database',
                'meta-source', 'meta-flow', 'meta-database',
                'kb-source', 'kb-flow', 'kb-database',
                'data-source', 'data-flow', 'data-key', 'data-database',
                'compare-source', 'compare-flow', 'compare-key', 'compare-database', 'compare-label'
            ];

            allFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('change', () => {
                        // Find which tab this field belongs to
                        const activeTab = document.querySelector('.tab-content.active');
                        if (activeTab) {
                            const tabName = activeTab.id.replace('-tab', '');
                            updateUrlFromForm(tabName);
                        }
                    });
                }
            });
        }

        // ========================================================================
        // API FUNCTIONS
        // ========================================================================

        /**
         * Generic API call handler with UI updates
         * @param {string} endpoint - API endpoint
         * @param {Object} body - Request body
         * @param {string} responseElementId - ID of response container
         * @param {string} contentElementId - ID of content element
         */
        async function apiCall(endpoint, body, responseElementId, contentElementId) {
            const responseEl = document.getElementById(responseElementId);
            const contentEl = document.getElementById(contentElementId);

            responseEl.style.display = 'block';
            responseEl.classList.remove('error', 'success');
            contentEl.textContent = 'Loading...';

            try {
                const data = await fetchAPI(endpoint, body);
                displaySuccess(responseElementId, contentElementId, data);
            } catch (error) {
                displayError(responseElementId, contentElementId, error.message);
            }
        }

        function getAbout() {
            const prettyView = document.getElementById('about-pretty-view');
            const copyDropdown = document.getElementById('about-copy-dropdown');

            if (!prettyView) {
                console.error('About pretty view element not found');
                return;
            }

            // Show pretty view
            prettyView.style.display = 'block';
            copyDropdown.style.display = 'none';

            fetch(API_BASE + '/about', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                // Store response data for copying
                window.aboutResponseData = data;

                // Show copy dropdown
                copyDropdown.style.display = 'inline-block';

                // Render pretty view
                renderPrettyAbout(data);
            })
            .catch(error => {
                const container = document.getElementById('about-pretty-content');
                if (container) {
                    container.innerHTML = `<div style="text-align: center; padding: 40px; color: #cc0000;">Error: ${escapeHtml(error.message)}</div>`;
                }
            });
        }


        function renderPrettyAbout(data) {
            const container = document.getElementById('about-pretty-content');
            let html = '';

            html += '<div style="max-width: 800px; margin: 0 auto;">';


            // Main info grid
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">';

            // Version
            if (data.version) {
                html += '<div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #e0e0e0;">';
                html += '<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">';
                html += '<span class="material-symbols-outlined" style="color: #003D6D; font-size: 32px;">info</span>';
                html += '<h3 style="margin: 0; color: #003D6D;">Version</h3>';
                html += '</div>';
                html += `<p style="font-size: 24px; font-weight: bold; color: #333; margin: 0;">${escapeHtml(data.version)}</p>`;
                html += '</div>';
            }

            // Name
            if (data.name) {
                html += '<div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #e0e0e0;">';
                html += '<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">';
                html += '<span class="material-symbols-outlined" style="color: #003D6D; font-size: 32px;">sdk</span>';
                html += '<h3 style="margin: 0; color: #003D6D;">Library</h3>';
                html += '</div>';
                html += `<p style="font-size: 18px; color: #333; margin: 0;">${escapeHtml(data.name)}</p>`;
                html += '</div>';
            }

            html += '</div>';

            // Description
            if (data.description) {
                html += '<div style="background: white; padding: 25px; border-radius: 8px; border: 2px solid #e0e0e0; margin-bottom: 20px;">';
                html += '<h3 style="color: #003D6D; margin: 0 0 15px 0;">About</h3>';
                html += `<p style="color: #666; line-height: 1.6; margin: 0;">${escapeHtml(data.description)}</p>`;
                html += '</div>';
            }

            // Features/Capabilities
            html += '<div style="background: white; padding: 25px; border-radius: 8px; border: 2px solid #e0e0e0;">';
            html += '<h3 style="color: #003D6D; margin: 0 0 20px 0;">Features</h3>';
            html += '<div style="display: grid; gap: 15px;">';

            const features = [
                { icon: 'cloud_download', label: 'Download SDMX data from multiple sources' },
                { icon: 'api', label: 'RESTful API with gRPC support' },
                { icon: 'security', label: 'Secure authentication and authorization' },
                { icon: 'speed', label: 'High-performance data retrieval' },
                { icon: 'format_list_bulleted', label: 'Support for multiple SDMX formats' },
                { icon: 'database', label: 'Access to multiple statistical databases' }
            ];

            features.forEach(feature => {
                html += '<div style="display: flex; align-items: center; gap: 12px;">';
                html += `<span class="material-symbols-outlined" style="color: #4caf50; font-size: 24px;">${feature.icon}</span>`;
                html += `<span style="color: #333;">${feature.label}</span>`;
                html += '</div>';
            });

            html += '</div>';
            html += '</div>';

            html += '</div>';

            container.innerHTML = html;
        }

        // ========================================================================
        // SOURCES TAB FUNCTIONALITY
        // ========================================================================

        function getSources() {
            const copyDropdown = document.getElementById('sources-copy-dropdown');
            const prettyView = document.getElementById('sources-pretty-view');

            // Show pretty view initially
            prettyView.style.display = 'block';
            copyDropdown.style.display = 'none';

            fetch(API_BASE + '/sources', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                copyDropdown.style.display = 'inline-block';

                // Store response data for copying
                window.sourcesResponseData = data;

                // Render pretty view
                renderPrettySources(data);

                // Setup filter functionality
                setupSourcesFilter();
            })
            .catch(error => {
                prettyView.style.display = 'none';
                alert(`Error fetching sources: ${error.message}`);
            });
        }

        // Button ripple micro-interaction
        (function attachRipple(){
            const buttons = document.querySelectorAll('button, .source-action-btn, .flow-action-btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', function(e){
                    const rect = this.getBoundingClientRect();
                    const ripple = document.createElement('span');
                    ripple.className = 'ripple';
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size/2;
                    const y = e.clientY - rect.top - size/2;
                    ripple.style.width = ripple.style.height = size + 'px';
                    ripple.style.left = x + 'px';
                    ripple.style.top = y + 'px';
                    this.appendChild(ripple);
                    ripple.addEventListener('animationend', () => ripple.remove());
                });
            });
        })();

        // Smooth dropdown toggle (keep existing logic, just add class)

        function toggleSourcesCopyDropdown() {
            toggleDropdown('sources-copy-dropdown');
        }

        function copySourcesJSON() {
            const dropdown = document.getElementById('sources-copy-dropdown');
            dropdown.classList.remove('open');

            if (!window.sourcesResponseData) {
                alert('No data available to copy. Please fetch sources first.');
                return;
            }

            const jsonText = JSON.stringify(window.sourcesResponseData, null, 2);
            navigator.clipboard.writeText(jsonText).then(() => {
                showCopyFeedback('sources-copy-dropdown', 'JSON copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function copySourcesCurlBash() {
            const dropdown = document.getElementById('sources-copy-dropdown');
            dropdown.classList.remove('open');

            const curlCommand = `curl -X POST '${window.location.origin}${API_BASE}/sources' \\
  -H 'Content-Type: application/json' \\
  -d '{}'`;

            navigator.clipboard.writeText(curlCommand).then(() => {
                showCopyFeedback('sources-copy-dropdown', 'cURL (bash) copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function copySourcesCurlCmd() {
            const dropdown = document.getElementById('sources-copy-dropdown');
            dropdown.classList.remove('open');

            const curlCommand = `curl -X POST "${window.location.origin}${API_BASE}/sources" ^
  -H "Content-Type: application/json" ^
  -d "{}"`;

            navigator.clipboard.writeText(curlCommand).then(() => {
                showCopyFeedback('sources-copy-dropdown', 'cURL (cmd) copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function copySourcesCurlPowerShell() {
            const dropdown = document.getElementById('sources-copy-dropdown');
            dropdown.classList.remove('open');

            const psCommand = `Invoke-RestMethod \`
  -Uri '${window.location.origin}${API_BASE}/sources' \`
  -Method Post \`
  -ContentType 'application/json' \`
  -Body '{}'`;

            navigator.clipboard.writeText(psCommand).then(() => {
                showCopyFeedback('sources-copy-dropdown', 'PowerShell copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function showCopyFeedback(dropdownId, message) {
            const dropdown = document.getElementById(dropdownId);
            const button = dropdown.querySelector('.dropdown-button');
            const originalHTML = button.innerHTML;

            button.innerHTML = `<span class="material-symbols-outlined">check</span> ${message}`;
            button.style.background = '#4caf50';
            button.style.borderColor = '#4caf50';

            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.style.background = '';
                button.style.borderColor = '';
            }, 2000);
        }

        // ========================================================================
        // ABOUT TAB COPY FUNCTIONS
        // ========================================================================

        function toggleAboutCopyDropdown() {
            toggleDropdown('about-copy-dropdown');
        }

        function copyAboutJSON() {
            const dropdown = document.getElementById('about-copy-dropdown');
            dropdown.classList.remove('open');

            if (!window.aboutResponseData) {
                alert('No data available to copy. Please fetch information first.');
                return;
            }

            const jsonText = JSON.stringify(window.aboutResponseData, null, 2);
            navigator.clipboard.writeText(jsonText).then(() => {
                showCopyFeedback('about-copy-dropdown', 'JSON copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function copyAboutCurlBash() {
            const dropdown = document.getElementById('about-copy-dropdown');
            dropdown.classList.remove('open');

            const curlCommand = `curl -X POST '${window.location.origin}${API_BASE}/about' \\
  -H 'Content-Type: application/json' \\
  -d '{}'`;

            navigator.clipboard.writeText(curlCommand).then(() => {
                showCopyFeedback('about-copy-dropdown', 'cURL (bash) copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function copyAboutCurlCmd() {
            const dropdown = document.getElementById('about-copy-dropdown');
            dropdown.classList.remove('open');

            const curlCommand = `curl -X POST "${window.location.origin}${API_BASE}/about" ^
  -H "Content-Type: application/json" ^
  -d "{}"`;

            navigator.clipboard.writeText(curlCommand).then(() => {
                showCopyFeedback('about-copy-dropdown', 'cURL (cmd) copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function copyAboutCurlPowerShell() {
            const dropdown = document.getElementById('about-copy-dropdown');
            dropdown.classList.remove('open');

            const psCommand = `Invoke-RestMethod \`
  -Uri '${window.location.origin}${API_BASE}/about' \`
  -Method Post \`
  -ContentType 'application/json' \`
  -Body '{}'`;

            navigator.clipboard.writeText(psCommand).then(() => {
                showCopyFeedback('about-copy-dropdown', 'PowerShell copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        // ========================================================================
        // DATABASES COPY FUNCTIONS
        // ========================================================================

        function toggleDatabasesCopyDropdown() {
            toggleDropdown('databases-copy-dropdown');
        }

        function copyDatabasesJSON() {
            const dropdown = document.getElementById('databases-copy-dropdown');
            dropdown.classList.remove('open');

            if (!window.databasesResponseData) {
                alert('No data available to copy. Please fetch databases first.');
                return;
            }

            const jsonText = JSON.stringify(window.databasesResponseData, null, 2);
            navigator.clipboard.writeText(jsonText).then(() => {
                showCopyFeedback('databases-copy-dropdown', 'JSON copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function copyDatabasesCurlBash() {
            const dropdown = document.getElementById('databases-copy-dropdown');
            dropdown.classList.remove('open');

            if (!window.databasesRequestParams) {
                alert('No request data available.');
                return;
            }

            const body = JSON.stringify(window.databasesRequestParams);
            const curlCommand = `curl -X POST '${window.location.origin}${API_BASE}/databases' \\
  -H 'Content-Type: application/json' \\
  -d '${body}'`;

            navigator.clipboard.writeText(curlCommand).then(() => {
                showCopyFeedback('databases-copy-dropdown', 'cURL (bash) copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function copyDatabasesCurlCmd() {
            const dropdown = document.getElementById('databases-copy-dropdown');
            dropdown.classList.remove('open');

            if (!window.databasesRequestParams) {
                alert('No request data available.');
                return;
            }

            const body = JSON.stringify(window.databasesRequestParams).replace(/"/g, '\\"');
            const curlCommand = `curl -X POST "${window.location.origin}${API_BASE}/databases" ^
  -H "Content-Type: application/json" ^
  -d "${body}"`;

            navigator.clipboard.writeText(curlCommand).then(() => {
                showCopyFeedback('databases-copy-dropdown', 'cURL (cmd) copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function copyDatabasesCurlPowerShell() {
            const dropdown = document.getElementById('databases-copy-dropdown');
            dropdown.classList.remove('open');

            if (!window.databasesRequestParams) {
                alert('No request data available.');
                return;
            }

            const body = JSON.stringify(window.databasesRequestParams).replace(/'/g, "''");
            const psCommand = `Invoke-RestMethod \`
  -Uri '${window.location.origin}${API_BASE}/databases' \`
  -Method Post \`
  -ContentType 'application/json' \`
  -Body '${body}'`;

            navigator.clipboard.writeText(psCommand).then(() => {
                showCopyFeedback('databases-copy-dropdown', 'PowerShell copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        // ========================================================================
        // FLOWS COPY FUNCTIONS
        // ========================================================================

        function toggleFlowsCopyDropdown() {
            toggleDropdown('flows-copy-dropdown');
        }

        function copyFlowsJSON() {
            const dropdown = document.getElementById('flows-copy-dropdown');
            dropdown.classList.remove('open');

            if (!window.flowsResponseData) {
                alert('No data available to copy. Please fetch flows first.');
                return;
            }

            const jsonText = JSON.stringify(window.flowsResponseData, null, 2);
            navigator.clipboard.writeText(jsonText).then(() => {
                showCopyFeedback('flows-copy-dropdown', 'JSON copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function copyFlowsCurlBash() {
            const dropdown = document.getElementById('flows-copy-dropdown');
            dropdown.classList.remove('open');

            if (!window.flowsRequestParams) {
                alert('No request data available.');
                return;
            }

            const body = JSON.stringify(window.flowsRequestParams);
            const curlCommand = `curl -X POST '${window.location.origin}${API_BASE}/flows' \\
  -H 'Content-Type: application/json' \\
  -d '${body}'`;

            navigator.clipboard.writeText(curlCommand).then(() => {
                showCopyFeedback('flows-copy-dropdown', 'cURL (bash) copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function copyFlowsCurlCmd() {
            const dropdown = document.getElementById('flows-copy-dropdown');
            dropdown.classList.remove('open');

            if (!window.flowsRequestParams) {
                alert('No request data available.');
                return;
            }

            const body = JSON.stringify(window.flowsRequestParams).replace(/"/g, '\\"');
            const curlCommand = `curl -X POST "${window.location.origin}${API_BASE}/flows" ^
  -H "Content-Type: application/json" ^
  -d "${body}"`;

            navigator.clipboard.writeText(curlCommand).then(() => {
                showCopyFeedback('flows-copy-dropdown', 'cURL (cmd) copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function copyFlowsCurlPowerShell() {
            const dropdown = document.getElementById('flows-copy-dropdown');
            dropdown.classList.remove('open');

            if (!window.flowsRequestParams) {
                alert('No request data available.');
                return;
            }

            const body = JSON.stringify(window.flowsRequestParams).replace(/'/g, "''");
            const psCommand = `Invoke-RestMethod \`
  -Uri '${window.location.origin}${API_BASE}/flows' \`
  -Method Post \`
  -ContentType 'application/json' \`
  -Body '${body}'`;

            navigator.clipboard.writeText(psCommand).then(() => {
                showCopyFeedback('flows-copy-dropdown', 'PowerShell copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        // ========================================================================
        // META COPY FUNCTIONS
        // ========================================================================

        function toggleMetaCopyDropdown() {
            toggleDropdown('meta-copy-dropdown');
        }

        function copyMetaJSON() {
            const dropdown = document.getElementById('meta-copy-dropdown');
            dropdown.classList.remove('open');

            if (!window.metaResponseData) {
                alert('No data available to copy. Please fetch meta first.');
                return;
            }

            const jsonText = JSON.stringify(window.metaResponseData, null, 2);
            navigator.clipboard.writeText(jsonText).then(() => {
                showCopyFeedback('meta-copy-dropdown', 'JSON copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function copyMetaCurlBash() {
            const dropdown = document.getElementById('meta-copy-dropdown');
            dropdown.classList.remove('open');

            if (!window.metaRequestParams) {
                alert('No request data available.');
                return;
            }

            const body = JSON.stringify(window.metaRequestParams);
            const curlCommand = `curl -X POST '${window.location.origin}${API_BASE}/meta' \\
  -H 'Content-Type: application/json' \\
  -d '${body}'`;

            navigator.clipboard.writeText(curlCommand).then(() => {
                showCopyFeedback('meta-copy-dropdown', 'cURL (bash) copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function copyMetaCurlCmd() {
            const dropdown = document.getElementById('meta-copy-dropdown');
            dropdown.classList.remove('open');

            if (!window.metaRequestParams) {
                alert('No request data available.');
                return;
            }

            const body = JSON.stringify(window.metaRequestParams).replace(/"/g, '\\"');
            const curlCommand = `curl -X POST "${window.location.origin}${API_BASE}/meta" ^
  -H "Content-Type: application/json" ^
  -d "${body}"`;

            navigator.clipboard.writeText(curlCommand).then(() => {
                showCopyFeedback('meta-copy-dropdown', 'cURL (cmd) copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function copyMetaCurlPowerShell() {
            const dropdown = document.getElementById('meta-copy-dropdown');
            dropdown.classList.remove('open');

            if (!window.metaRequestParams) {
                alert('No request data available.');
                return;
            }

            const body = JSON.stringify(window.metaRequestParams).replace(/'/g, "''");
            const psCommand = `Invoke-RestMethod \`
  -Uri '${window.location.origin}${API_BASE}/meta' \`
  -Method Post \`
  -ContentType 'application/json' \`
  -Body '${body}'`;

            navigator.clipboard.writeText(psCommand).then(() => {
                showCopyFeedback('meta-copy-dropdown', 'PowerShell copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        // ========================================================================
        // DATA COPY FUNCTIONS
        // ========================================================================

        function toggleDataCopyDropdown() {
            toggleDropdown('data-copy-dropdown');
        }

        function copyDataJSON() {
            const dropdown = document.getElementById('data-copy-dropdown');
            dropdown.classList.remove('open');

            if (!window.dataResponseData) {
                alert('No data available to copy. Please fetch data first.');
                return;
            }

            const jsonText = JSON.stringify(window.dataResponseData, null, 2);
            navigator.clipboard.writeText(jsonText).then(() => {
                showCopyFeedback('data-copy-dropdown', 'JSON copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function copyDataCurlBash() {
            const dropdown = document.getElementById('data-copy-dropdown');
            dropdown.classList.remove('open');

            if (!window.dataRequestParams) {
                alert('No request data available.');
                return;
            }

            const body = JSON.stringify(window.dataRequestParams);
            const curlCommand = `curl -X POST '${window.location.origin}${API_BASE}/data' \\
  -H 'Content-Type: application/json' \\
  -d '${body}'`;

            navigator.clipboard.writeText(curlCommand).then(() => {
                showCopyFeedback('data-copy-dropdown', 'cURL (bash) copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function copyDataCurlCmd() {
            const dropdown = document.getElementById('data-copy-dropdown');
            dropdown.classList.remove('open');

            if (!window.dataRequestParams) {
                alert('No request data available.');
                return;
            }

            const body = JSON.stringify(window.dataRequestParams).replace(/"/g, '\\"');
            const curlCommand = `curl -X POST "${window.location.origin}${API_BASE}/data" ^
  -H "Content-Type: application/json" ^
  -d "${body}"`;

            navigator.clipboard.writeText(curlCommand).then(() => {
                showCopyFeedback('data-copy-dropdown', 'cURL (cmd) copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function copyDataCurlPowerShell() {
            const dropdown = document.getElementById('data-copy-dropdown');
            dropdown.classList.remove('open');

            if (!window.dataRequestParams) {
                alert('No request data available.');
                return;
            }

            const body = JSON.stringify(window.dataRequestParams).replace(/'/g, "''");
            const psCommand = `Invoke-RestMethod \`
  -Uri '${window.location.origin}${API_BASE}/data' \`
  -Method Post \`
  -ContentType 'application/json' \`
  -Body '${body}'`;

            navigator.clipboard.writeText(psCommand).then(() => {
                showCopyFeedback('data-copy-dropdown', 'PowerShell copied!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const aboutDropdown = document.getElementById('about-view-dropdown');
            if (aboutDropdown && !aboutDropdown.contains(e.target)) {
                aboutDropdown.classList.remove('open');
            }

            const sourcesDropdown = document.getElementById('sources-view-dropdown');
            if (sourcesDropdown && !sourcesDropdown.contains(e.target)) {
                sourcesDropdown.classList.remove('open');
            }

            const sourcesCopyDropdown = document.getElementById('sources-copy-dropdown');
            if (sourcesCopyDropdown && !sourcesCopyDropdown.contains(e.target)) {
                sourcesCopyDropdown.classList.remove('open');
            }

            const databasesDropdown = document.getElementById('databases-view-dropdown');
            if (databasesDropdown && !databasesDropdown.contains(e.target)) {
                databasesDropdown.classList.remove('open');
            }

            const databasesCopyDropdown = document.getElementById('databases-copy-dropdown');
            if (databasesCopyDropdown && !databasesCopyDropdown.contains(e.target)) {
                databasesCopyDropdown.classList.remove('open');
            }

            const flowsDropdown = document.getElementById('flows-view-dropdown');
            if (flowsDropdown && !flowsDropdown.contains(e.target)) {
                flowsDropdown.classList.remove('open');
            }

            const flowsCopyDropdown = document.getElementById('flows-copy-dropdown');
            if (flowsCopyDropdown && !flowsCopyDropdown.contains(e.target)) {
                flowsCopyDropdown.classList.remove('open');
            }

            const metaDropdown = document.getElementById('meta-view-dropdown');
            if (metaDropdown && !metaDropdown.contains(e.target)) {
                metaDropdown.classList.remove('open');
            }

            const metaCopyDropdown = document.getElementById('meta-copy-dropdown');
            if (metaCopyDropdown && !metaCopyDropdown.contains(e.target)) {
                metaCopyDropdown.classList.remove('open');
            }

            const dataDropdown = document.getElementById('data-view-dropdown');
            if (dataDropdown && !dataDropdown.contains(e.target)) {
                dataDropdown.classList.remove('open');
            }

            const dataCopyDropdown = document.getElementById('data-copy-dropdown');
            if (dataCopyDropdown && !dataCopyDropdown.contains(e.target)) {
                dataCopyDropdown.classList.remove('open');
            }
        });

        function renderPrettySources(sources) {
            const container = document.getElementById('sources-pretty-content');
            let html = '';


            // Advanced filter field
            html += '<div class="filter-box">';
            html += '<div class="filter-input-row">';
            html += '<div class="filter-input-container">';
            html += '<input type="text" id="sources-filter-input" placeholder="Filter sources by name, ID, endpoint, or driver..." />';
            html += '<div class="filter-inline-buttons">';
            html += '<button class="filter-clear-btn" id="sources-clear-filter" title="Clear Filter"></button>';
            html += '<button class="filter-inline-btn" id="sources-match-case" title="Match Case">Cc</button>';
            html += '<button class="filter-inline-btn" id="sources-whole-words" title="Whole Words">W</button>';
            html += '<button class="filter-inline-btn" id="sources-regex" title="Regex">.*</button>';
            html += '<button class="filter-inline-btn" id="sources-fuzzy" title="Fuzzy Search"></button>';
            html += '</div>';
            html += '</div>';
            html += '<div class="filter-actions">';
            html += '<span id="sources-filter-count" class="filter-count"></span>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // Sources grid
            html += '<div class="sources-grid">';

            sources.forEach(source => {
                // Create filterable text for this source
                const filterText = [
                    source.id,
                    source.driver || '',
                    source.endpoint || '',
                    source.website || '',
                    ...(source.names ? Object.values(source.names) : []),
                    ...(source.aliases || [])
                ].join(' ').toLowerCase();

                html += `<div class="source-card" data-filter-text="${escapeHtml(filterText)}" onclick="toggleSourceActions(this)">`;

                // Header with icon and title
                html += '<div class="source-header">';

                // Extract domain from website and use DuckDuckGo favicon
                // Only show favicon if confidentiality is PUBLIC or null/undefined
                let faviconHtml = '<span class="material-symbols-outlined" style="font-size: 32px;">public</span>'; // Default icon fallback
                const isPublicOrNull = !source.confidentiality || source.confidentiality === 'PUBLIC';
                if (source.website && isPublicOrNull) {
                    try {
                        const url = new URL(source.website);
                        const domain = url.hostname;
                        const faviconUrl = `https://icons.duckduckgo.com/ip3/${domain}.ico`;
                        faviconHtml = `<img src="${faviconUrl}" alt="${escapeHtml(source.id)}" onerror="this.style.display='none'; this.parentElement.innerHTML='<span class=\\'material-symbols-outlined\\' style=\\'font-size:32px\\'>public</span>';" style="width: 32px; height: 32px;">`;
                    } catch (e) {
                        // Keep default icon if URL parsing fails
                    }
                }

                html += `<div class="source-icon">${faviconHtml}</div>`;
                html += '<div class="source-title">';
                html += `<h4 class="source-id">${escapeHtml(source.id)}</h4>`;

                // Display the first name if available
                if (source.names && Object.keys(source.names).length > 0) {
                    const firstName = Object.values(source.names)[0];
                    html += `<p class="source-name">${escapeHtml(firstName)}</p>`;
                }

                html += '</div>';
                html += '</div>';

                // Source details
                html += '<div class="source-details">';

                // Driver
                if (source.driver) {
                    html += '<div class="source-detail-item">';
                    html += '<span class="source-detail-label">Driver:</span>';
                    html += `<span class="source-detail-value"><code>${escapeHtml(source.driver)}</code></span>`;
                    html += '</div>';
                }

                // Endpoint
                if (source.endpoint) {
                    html += '<div class="source-detail-item">';
                    html += '<span class="source-detail-label">Endpoint:</span>';
                    html += `<span class="source-detail-value" style="word-break: break-all; font-size: 11px;">${escapeHtml(source.endpoint)}</span>`;
                    html += '</div>';
                }

                // Confidentiality
                if (source.confidentiality) {
                    html += '<div class="source-detail-item">';
                    html += '<span class="source-detail-label">Access:</span>';
                    const confidentialityColor = source.confidentiality === 'PUBLIC' ? '#00cc00' : '#ff9900';
                    html += `<span class="source-detail-value" style="color: ${confidentialityColor}; font-weight: 600;">${escapeHtml(source.confidentiality)}</span>`;
                    html += '</div>';
                }

                // Website
                if (source.website) {
                    html += '<div class="source-detail-item">';
                    html += '<span class="source-detail-label">Website:</span>';
                    html += `<span class="source-detail-value"><a href="${escapeHtml(source.website)}" target="_blank" style="color: #003D6D;"><span class="material-symbols-outlined" style="font-size: 18px;">link</span> Visit</a></span>`;
                    html += '</div>';
                }

                // Monitor
                if (source.monitorWebsite) {
                    html += '<div class="source-detail-item">';
                    html += '<span class="source-detail-label">Monitor:</span>';
                    html += `<span class="source-detail-value"><a href="${escapeHtml(source.monitorWebsite)}" target="_blank" style="color: #003D6D;"><span class="material-symbols-outlined" style="font-size: 18px;">link</span> Status</a></span>`;
                    html += '</div>';
                }

                // Aliases
                if (source.aliases && source.aliases.length > 0) {
                    html += '<div class="source-detail-item">';
                    html += '<span class="source-detail-label">Aliases:</span>';
                    html += `<span class="source-detail-value">${source.aliases.map(a => escapeHtml(a)).join(', ')}</span>`;
                    html += '</div>';
                }

                // Languages
                if (source.names && Object.keys(source.names).length > 0) {
                    html += '<div class="source-detail-item">';
                    html += '<span class="source-detail-label">Languages:</span>';
                    html += '<span class="source-detail-value">';
                    const languages = Object.keys(source.names).map(lang => `<code style="background: #e8f4f8; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-right: 4px;">${escapeHtml(lang)}</code>`).join(' ');
                    html += languages;
                    html += '</span>';
                    html += '</div>';
                }

                html += '</div>'; // Close source-details

                // Properties section
                if (source.properties && Object.keys(source.properties).length > 0) {
                    html += '<div class="source-properties">';
                    html += '<div class="source-properties-title">Properties</div>';

                    Object.entries(source.properties).forEach(([key, value]) => {
                        html += '<div class="source-property">';
                        html += `<span class="source-property-key">${escapeHtml(key)}</span>`;
                        html += `<span class="source-property-value">${escapeHtml(value)}</span>`;
                        html += '</div>';
                    });

                    html += '</div>';
                }

                // Click hint
                html += '<div class="source-click-hint">Click card to show actions</div>';

                // Action buttons section (hidden by default)
                html += '<div class="source-actions">';
                html += '<div class="source-actions-title">Use in Other Tabs</div>';
                html += '<div class="source-action-buttons">';
                html += `<button class="source-action-btn" onclick="event.stopPropagation(); useSourceInTab('${escapeHtml(source.id)}', 'databases')" title="Get databases for this source"><span class="material-symbols-outlined">folder</span> Databases</button>`;
                html += `<button class="source-action-btn" onclick="event.stopPropagation(); useSourceInTab('${escapeHtml(source.id)}', 'flows')" title="Get flows for this source"><span class="material-symbols-outlined">query_stats</span> Flows</button>`;
                html += `<button class="source-action-btn" onclick="event.stopPropagation(); useSourceInTab('${escapeHtml(source.id)}', 'meta')" title="Get meta for this source"><span class="material-symbols-outlined">info</span> Meta</button>`;
                html += `<button class="source-action-btn" onclick="event.stopPropagation(); useSourceInTab('${escapeHtml(source.id)}', 'keybuilder')" title="Use in key builder"><span class="material-symbols-outlined">vpn_key</span> Key Builder</button>`;
                html += `<button class="source-action-btn" onclick="event.stopPropagation(); useSourceInTab('${escapeHtml(source.id)}', 'data')" title="Use in data tab"><span class="material-symbols-outlined">analytics</span> Data</button>`;
                html += `<button class="source-action-btn" onclick="event.stopPropagation(); useSourceInTab('${escapeHtml(source.id)}', 'compare')" title="Use in compare tab"><span class="material-symbols-outlined">compare_arrows</span> Compare</button>`;
                html += '</div>';
                html += '</div>';

                html += '</div>'; // Close source-card
            });

            html += '</div>'; // Close sources-grid

            container.innerHTML = html;
        }

        function toggleSourceActions(cardElement) {
            // Close all other expanded cards
            const allCards = document.querySelectorAll('.source-card');
            allCards.forEach(card => {
                if (card !== cardElement) {
                    card.classList.remove('expanded');
                }
            });

            // Toggle the clicked card
            cardElement.classList.toggle('expanded');
        }

        function useSourceInTab(sourceId, tabName) {
            // Fill the source field in the target tab
            switch(tabName) {
                case 'databases':
                    document.getElementById('db-source').value = sourceId;
                    switchTab('databases');
                    break;
                case 'flows':
                    document.getElementById('flows-source').value = sourceId;
                    switchTab('flows');
                    break;
                case 'meta':
                    document.getElementById('meta-source').value = sourceId;
                    switchTab('meta');
                    break;
                case 'keybuilder':
                    document.getElementById('kb-source').value = sourceId;
                    switchTab('keybuilder');
                    break;
                case 'data':
                    document.getElementById('data-source').value = sourceId;
                    switchTab('data');
                    break;
                case 'compare':
                    document.getElementById('compare-source').value = sourceId;
                    switchTab('compare');
                    break;
            }

            // Show a brief visual feedback
            const targetTab = Array.from(document.querySelectorAll('.tab')).find(tab =>
                tab.textContent.toLowerCase().includes(tabName.toLowerCase()) ||
                (tabName === 'keybuilder' && tab.textContent.includes('Key Builder')) ||
                (tabName === 'meta' && tab.textContent.includes('Meta'))
            );

            if (targetTab) {
                targetTab.style.background = '#00cc00';
                targetTab.style.color = 'white';
                setTimeout(() => {
                    targetTab.style.background = '';
                    targetTab.style.color = '';
                }, 1000);
            }
        }

        function toggleFlowActions(cardElement) {
            // Close all other expanded cards
            const allCards = document.querySelectorAll('.flow-card');
            allCards.forEach(card => {
                if (card !== cardElement) {
                    card.classList.remove('expanded');
                }
            });

            // Toggle the clicked card
            cardElement.classList.toggle('expanded');
        }

        function useFlowInTab(flowId, tabName) {
            // Get the current source from the flows tab
            const currentSource = document.getElementById('flows-source').value;
            const currentDatabase = document.getElementById('flows-database').value;

            // Fill the appropriate fields in the target tab
            switch(tabName) {
                case 'meta':
                    if (currentSource) {
                        document.getElementById('meta-source').value = currentSource;
                    }
                    document.getElementById('meta-flow').value = flowId;
                    if (currentDatabase) {
                        document.getElementById('meta-database').value = currentDatabase;
                    }
                    switchTab('meta');
                    break;
                case 'keybuilder':
                    if (currentSource) {
                        document.getElementById('kb-source').value = currentSource;
                    }
                    document.getElementById('kb-flow').value = flowId;
                    if (currentDatabase) {
                        document.getElementById('kb-database').value = currentDatabase;
                    }
                    switchTab('keybuilder');
                    break;
                case 'data':
                    if (currentSource) {
                        document.getElementById('data-source').value = currentSource;
                    }
                    document.getElementById('data-flow').value = flowId;
                    if (currentDatabase) {
                        document.getElementById('data-database').value = currentDatabase;
                    }
                    switchTab('data');
                    break;
                case 'compare':
                    if (currentSource) {
                        document.getElementById('compare-source').value = currentSource;
                    }
                    document.getElementById('compare-flow').value = flowId;
                    if (currentDatabase) {
                        document.getElementById('compare-database').value = currentDatabase;
                    }
                    switchTab('compare');
                    break;
            }

            // Show a brief visual feedback
            const targetTab = Array.from(document.querySelectorAll('.tab')).find(tab =>
                tab.textContent.toLowerCase().includes(tabName.toLowerCase()) ||
                (tabName === 'keybuilder' && tab.textContent.includes('Key Builder')) ||
                (tabName === 'meta' && tab.textContent.includes('Meta'))
            );

            if (targetTab) {
                targetTab.style.background = '#00cc00';
                targetTab.style.color = 'white';
                setTimeout(() => {
                    targetTab.style.background = '';
                    targetTab.style.color = '';
                }, 1000);
            }
        }

        function setupSourcesFilter() {
            const filterInput = document.getElementById('sources-filter-input');
            const filterCount = document.getElementById('sources-filter-count');
            const clearBtn = document.getElementById('sources-clear-filter');
            const matchCaseBtn = document.getElementById('sources-match-case');
            const wholeWordsBtn = document.getElementById('sources-whole-words');
            const regexBtn = document.getElementById('sources-regex');
            const fuzzyBtn = document.getElementById('sources-fuzzy');

            function performFilter() {
                const query = filterInput.value.trim();
                const cards = document.querySelectorAll('.source-card');

                if (!query) {
                    cards.forEach(card => card.classList.remove('filtered-hidden'));
                    const total = cards.length;
                    filterCount.textContent = `${total} sources`;
                    return;
                }

                let visibleCount = 0;
                const matchCase = matchCaseBtn.classList.contains('active');
                const wholeWords = wholeWordsBtn.classList.contains('active');
                const isRegex = regexBtn.classList.contains('active');
                const isFuzzy = fuzzyBtn.classList.contains('active');

                cards.forEach(card => {
                    const filterText = card.getAttribute('data-filter-text');

                    const matches = matchesFilter(filterText, query, {
                        matchCase,
                        wholeWords,
                        isRegex,
                        isFuzzy
                    });

                    if (matches) {
                        card.classList.remove('filtered-hidden');
                        visibleCount++;
                    } else {
                        card.classList.add('filtered-hidden');
                    }
                });

                const total = cards.length;
                filterCount.textContent = `${visibleCount} of ${total}`;
            }

            filterInput.addEventListener('input', performFilter);

            matchCaseBtn.addEventListener('click', function() {
                this.classList.toggle('active');
                performFilter();
            });

            wholeWordsBtn.addEventListener('click', function() {
                this.classList.toggle('active');
                performFilter();
            });

            regexBtn.addEventListener('click', function() {
                this.classList.toggle('active');
                performFilter();
            });

            fuzzyBtn.addEventListener('click', function() {
                this.classList.toggle('active');
                performFilter();
            });

            clearBtn.addEventListener('click', function() {
                filterInput.value = '';
                matchCaseBtn.classList.remove('active');
                wholeWordsBtn.classList.remove('active');
                regexBtn.classList.remove('active');
                fuzzyBtn.classList.remove('active');
                performFilter();
            });

            filterInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    clearBtn.click();
                }
            });

            // Initialize the filter count display
            performFilter();
        }

        // ========================================================================
        // FLOWS TAB FUNCTIONALITY
        // ========================================================================

        /**
         * Fetch and display flows for a source
         */
        function getFlows() {
            const source = document.getElementById('flows-source').value;
            const database = document.getElementById('flows-database').value;

            if (!source) {
                alert('Please enter a source ID');
                return;
            }

            const body = { source };
            if (database) {
                body.database = database;
            }

            const copyDropdown = document.getElementById('flows-copy-dropdown');
            const prettyView = document.getElementById('flows-pretty-view');

            // Show pretty view initially
            prettyView.style.display = 'block';
            copyDropdown.style.display = 'none';

            fetch(API_BASE + '/flows', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(body)
            })
            .then(response => response.json())
            .then(data => {
                copyDropdown.style.display = 'inline-block';

                // Store response data and request params for copying
                window.flowsResponseData = data;
                window.flowsRequestParams = body;

                // Render pretty view
                renderPrettyFlows(data);

                // Setup filter functionality
                setupFlowsFilter();
            })
            .catch(error => {
                prettyView.style.display = 'none';
                alert(`Error fetching flows: ${error.message}`);
            });
        }

        /**
         * Generate a GitHub-style identicon based on flow ID hash
         * @param {Object} flow - Flow object with id/ref
         * @returns {string} - SVG identicon HTML
         */
        function getFlowIcon(flow) {
            const id = flow.ref || flow.id || 'default';

            // Simple hash function for string
            function hashCode(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return Math.abs(hash);
            }

            // Seeded random number generator
            function seededRandom(seed) {
                const x = Math.sin(seed++) * 10000;
                return x - Math.floor(x);
            }

            const hash = hashCode(id);

            // Color palette - vibrant colors like GitHub
            const colors = [
                '#0969DA', '#1F883D', '#CF222E', '#8250DF', '#BF3989',
                '#FB8500', '#0550AE', '#116329', '#A40E26', '#6639BA',
                '#D1242F', '#0969DA', '#218BFF', '#7D4E57', '#953800',
                '#6639BA', '#8B5CF6', '#3B82F6', '#10B981', '#F59E0B'
            ];

            // Select base color from hash
            const colorIndex = hash % colors.length;
            const baseColor = colors[colorIndex];

            // Generate 5x5 grid pattern (symmetric for better appearance)
            const gridSize = 5;
            const cellSize = 32 / gridSize;
            let svg = `<svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">`;

            // Background
            svg += `<rect width="32" height="32" fill="#f6f8fa"/>`;

            // Generate pattern - only need to generate left half + middle, mirror to right
            for (let row = 0; row < gridSize; row++) {
                for (let col = 0; col < Math.ceil(gridSize / 2); col++) {
                    const seed = hash + row * gridSize + col;
                    const shouldFill = seededRandom(seed) > 0.5;

                    if (shouldFill) {
                        const x = col * cellSize;
                        const y = row * cellSize;
                        const opacity = 0.7 + seededRandom(seed + 100) * 0.3;

                        // Draw left/middle cell
                        svg += `<rect x="${x}" y="${y}" width="${cellSize}" height="${cellSize}" fill="${baseColor}" opacity="${opacity}"/>`;

                        // Mirror to right side (except middle column)
                        if (col < Math.floor(gridSize / 2)) {
                            const mirrorX = (gridSize - 1 - col) * cellSize;
                            svg += `<rect x="${mirrorX}" y="${y}" width="${cellSize}" height="${cellSize}" fill="${baseColor}" opacity="${opacity}"/>`;
                        }
                    }
                }
            }

            svg += '</svg>';
            return svg;
        }

        function renderPrettyFlows(flows) {
            const container = document.getElementById('flows-pretty-content');
            let html = '';


            // Advanced filter field
            html += '<div class="filter-box">';
            html += '<div class="filter-input-row">';
            html += '<div class="filter-input-container">';
            html += '<input type="text" id="flows-filter-input" placeholder="Filter flows by ID, name, or description..." />';
            html += '<div class="filter-inline-buttons">';
            html += '<button class="filter-clear-btn" id="flows-clear-filter" title="Clear Filter"></button>';
            html += '<button class="filter-inline-btn" id="flows-match-case" title="Match Case">Cc</button>';
            html += '<button class="filter-inline-btn" id="flows-whole-words" title="Whole Words">W</button>';
            html += '<button class="filter-inline-btn" id="flows-regex" title="Regex">.*</button>';
            html += '<button class="filter-inline-btn" id="flows-fuzzy" title="Fuzzy Search"></button>';
            html += '</div>';
            html += '</div>';
            html += '<div class="filter-actions">';
            html += '<span id="flows-filter-count" class="filter-count"></span>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // Flows grid
            html += '<div class="flows-grid">';

            flows.forEach(flow => {
                // Create filterable text for this flow (name, reference, description only)
                const filterText = [
                    flow.ref || flow.id || '',
                    flow.name || '',
                    flow.description || ''
                ].join(' ').toLowerCase();

                html += `<div class="flow-card" data-filter-text="${escapeHtml(filterText)}" onclick="toggleFlowActions(this)">`;

                // Header with icon and title
                html += '<div class="flow-header">';
                html += `<div class="flow-icon">${getFlowIcon(flow)}</div>`;
                html += '<div class="flow-title">';
                html += `<h4 class="flow-id">${escapeHtml(flow.ref || flow.id || 'N/A')}</h4>`;

                if (flow.name) {
                    html += `<p class="flow-name">${escapeHtml(flow.name)}</p>`;
                }

                html += '</div>';
                html += '</div>';

                // Description
                if (flow.description) {
                    html += `<div class="flow-description">${escapeHtml(flow.description)}</div>`;
                }

                // Meta info
                html += '<div class="flow-meta">';

                if (flow.structureRef) {
                    html += '<div class="flow-meta-item">';
                    html += ' Structure: ';
                    html += `<code>${escapeHtml(flow.structureRef)}</code>`;
                    html += '</div>';
                }

                html += '</div>';

                // Click hint
                html += '<div class="flow-click-hint">Click card to show actions</div>';

                // Action buttons section (hidden by default)
                html += '<div class="flow-actions">';
                html += '<div class="flow-actions-title">Use in Other Tabs</div>';
                html += '<div class="flow-action-buttons">';
                html += `<button class="flow-action-btn" onclick="event.stopPropagation(); useFlowInTab('${escapeHtml(flow.ref || flow.id || '')}', 'meta')" title="Get meta for this flow"><span class="material-symbols-outlined">info</span> Meta</button>`;
                html += `<button class="flow-action-btn" onclick="event.stopPropagation(); useFlowInTab('${escapeHtml(flow.ref || flow.id || '')}', 'keybuilder')" title="Use in key builder"><span class="material-symbols-outlined">vpn_key</span> Key Builder</button>`;
                html += `<button class="flow-action-btn" onclick="event.stopPropagation(); useFlowInTab('${escapeHtml(flow.ref || flow.id || '')}', 'data')" title="Use in data tab"><span class="material-symbols-outlined">analytics</span> Data</button>`;
                html += `<button class="flow-action-btn" onclick="event.stopPropagation(); useFlowInTab('${escapeHtml(flow.ref || flow.id || '')}', 'compare')" title="Use in compare tab"><span class="material-symbols-outlined">compare_arrows</span> Compare</button>`;
                html += '</div>';
                html += '</div>';

                html += '</div>'; // Close flow-card
            });

            html += '</div>'; // Close flows-grid

            container.innerHTML = html;
        }

        function setupFlowsFilter() {
            const filterInput = document.getElementById('flows-filter-input');
            const filterCount = document.getElementById('flows-filter-count');
            const clearBtn = document.getElementById('flows-clear-filter');
            const matchCaseBtn = document.getElementById('flows-match-case');
            const wholeWordsBtn = document.getElementById('flows-whole-words');
            const regexBtn = document.getElementById('flows-regex');
            const fuzzyBtn = document.getElementById('flows-fuzzy');

            function performFilter() {
                const query = filterInput.value.trim();
                const cards = document.querySelectorAll('.flow-card');

                if (!query) {
                    cards.forEach(card => card.classList.remove('filtered-hidden'));
                    const total = cards.length;
                    filterCount.textContent = `${total} flows`;
                    return;
                }

                let visibleCount = 0;
                const matchCase = matchCaseBtn.classList.contains('active');
                const wholeWords = wholeWordsBtn.classList.contains('active');
                const isRegex = regexBtn.classList.contains('active');
                const isFuzzy = fuzzyBtn.classList.contains('active');

                cards.forEach(card => {
                    const filterText = card.getAttribute('data-filter-text');

                    const matches = matchesFilter(filterText, query, {
                        matchCase,
                        wholeWords,
                        isRegex,
                        isFuzzy
                    });

                    if (matches) {
                        card.classList.remove('filtered-hidden');
                        visibleCount++;
                    } else {
                        card.classList.add('filtered-hidden');
                    }
                });

                const total = cards.length;
                filterCount.textContent = `${visibleCount} of ${total}`;
            }

            filterInput.addEventListener('input', performFilter);

            matchCaseBtn.addEventListener('click', function() {
                this.classList.toggle('active');
                performFilter();
            });

            wholeWordsBtn.addEventListener('click', function() {
                this.classList.toggle('active');
                performFilter();
            });

            regexBtn.addEventListener('click', function() {
                this.classList.toggle('active');
                performFilter();
            });

            fuzzyBtn.addEventListener('click', function() {
                this.classList.toggle('active');
                performFilter();
            });

            clearBtn.addEventListener('click', function() {
                filterInput.value = '';
                matchCaseBtn.classList.remove('active');
                wholeWordsBtn.classList.remove('active');
                regexBtn.classList.remove('active');
                fuzzyBtn.classList.remove('active');
                performFilter();
            });

            filterInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    clearBtn.click();
                }
            });

            // Initialize the filter count display
            performFilter();
        }

        // ========================================================================
        // DATABASES TAB FUNCTIONALITY
        // ========================================================================

        function getDatabases() {
            const source = document.getElementById('db-source').value;
            if (!source) {
                alert('Please enter a source ID');
                return;
            }

            const copyDropdown = document.getElementById('databases-copy-dropdown');
            const prettyView = document.getElementById('databases-pretty-view');

            // Show pretty view initially
            prettyView.style.display = 'block';
            copyDropdown.style.display = 'none';

            const body = { source };

            fetch(API_BASE + '/databases', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(body)
            })
            .then(response => response.json())
            .then(data => {
                copyDropdown.style.display = 'inline-block';

                // Store response data and request params for copying
                window.databasesResponseData = data;
                window.databasesRequestParams = body;

                // Render pretty view
                renderPrettyDatabases(data);
            })
            .catch(error => {
                prettyView.style.display = 'none';
                alert(`Error fetching databases: ${error.message}`);
            });
        }

        function renderPrettyDatabases(databases) {
            const container = document.getElementById('databases-pretty-content');
            let html = '';

            if (!databases || databases.length === 0) {
                html += '<div class="no-results">';
                html += '<div class="no-results-icon"></div>';
                html += '<p>No databases available</p>';
                html += '</div>';
                container.innerHTML = html;
                return;
            }

            // Databases grid
            html += '<div class="sources-grid">';

            databases.forEach(db => {
                html += '<div class="source-card">';
                html += '<div class="source-header">';
                html += '<div class="source-icon" style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); border-color: #1b5e20;">';
                html += '<span class="material-symbols-outlined" style="color: white;">folder</span>';
                html += '</div>';
                html += '<div class="source-title">';
                html += `<div class="source-id">${escapeHtml(db.ref || db.id || 'N/A')}</div>`;
                html += `<div class="source-name">${escapeHtml(db.label || db.name || 'Unnamed Database')}</div>`;
                html += '</div>';
                html += '</div>';
                html += '</div>';
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // ========================================================================
        // METADATA TAB FUNCTIONALITY
        // ========================================================================

        /**
         * Fetch and display metadata for a flow
         */
        function getMeta() {
            const source = document.getElementById('meta-source').value;
            const flow = document.getElementById('meta-flow').value;
            const database = document.getElementById('meta-database').value;

            if (!source || !flow) {
                alert('Please enter both source ID and flow ID');
                return;
            }

            const body = { source, flow };
            if (database) {
                body.database = database;
            }

            // Show loading and reset views
            const prettyView = document.getElementById('meta-pretty-view');
            const copyDropdown = document.getElementById('meta-copy-dropdown');

            // Show pretty view initially
            prettyView.style.display = 'block';
            copyDropdown.style.display = 'none';

            fetch(API_BASE + '/meta', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(body)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || `HTTP ${response.status}: ${response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                copyDropdown.style.display = 'inline-block';

                // Store response data and request params for copying
                window.metaResponseData = data;
                window.metaRequestParams = body;

                // Render pretty view
                renderPrettyMeta(data);
            })
            .catch(error => {
                prettyView.style.display = 'none';
                alert(`Error fetching metadata: ${error.message}`);
            });
        }

        function renderPrettyMeta(data) {
            const container = document.getElementById('meta-pretty-content');
            let html = '';

            // Flow Information Section
            if (data.flow) {
                html += '<div class="meta-section">';
                html += '<h3>Flow Information</h3>';
                html += '<div class="meta-info-grid">';

                if (data.flow.ref) {
                    html += '<div class="meta-info-item">';
                    html += '<div class="meta-info-label">Flow Reference</div>';
                    html += `<div class="meta-info-value"><code>${data.flow.ref}</code></div>`;
                    html += '</div>';
                }

                if (data.flow.name) {
                    html += '<div class="meta-info-item">';
                    html += '<div class="meta-info-label">Name</div>';
                    html += `<div class="meta-info-value">${data.flow.name}</div>`;
                    html += '</div>';
                }

                if (data.flow.structureRef) {
                    html += '<div class="meta-info-item">';
                    html += '<div class="meta-info-label">Structure Reference</div>';
                    html += `<div class="meta-info-value"><code>${data.flow.structureRef}</code></div>`;
                    html += '</div>';
                }

                if (data.flow.description) {
                    html += '<div class="meta-info-item" style="grid-column: 1 / -1;">';
                    html += '<div class="meta-info-label">Description</div>';
                    html += `<div class="meta-info-value">${data.flow.description}</div>`;
                    html += '</div>';
                }

                html += '</div>';
                html += '</div>';
            }

            // Structure Information Section
            if (data.structure) {
                html += '<div class="meta-section">';
                html += '<h3>Data Structure</h3>';
                html += '<div class="meta-info-grid">';

                if (data.structure.ref) {
                    html += '<div class="meta-info-item">';
                    html += '<div class="meta-info-label">Structure Reference</div>';
                    html += `<div class="meta-info-value"><code>${data.structure.ref}</code></div>`;
                    html += '</div>';
                }

                if (data.structure.name) {
                    html += '<div class="meta-info-item">';
                    html += '<div class="meta-info-label">Structure Name</div>';
                    html += `<div class="meta-info-value">${data.structure.name}</div>`;
                    html += '</div>';
                }

                if (data.structure.timeDimensionId) {
                    html += '<div class="meta-info-item">';
                    html += '<div class="meta-info-label">Time Dimension ID</div>';
                    html += `<div class="meta-info-value"><code>${data.structure.timeDimensionId}</code></div>`;
                    html += '</div>';
                }

                if (data.structure.primaryMeasureId) {
                    html += '<div class="meta-info-item">';
                    html += '<div class="meta-info-label">Primary Measure ID</div>';
                    html += `<div class="meta-info-value"><code>${data.structure.primaryMeasureId}</code></div>`;
                    html += '</div>';
                }

                html += '</div>';

                // Dimensions Table
                if (data.structure.dimensions && data.structure.dimensions.length > 0) {
                    html += '<h4 style="margin: 20px 0 10px 0; color: #333;">Dimensions</h4>';
                    html += '<table class="dimensions-table">';
                    html += '<thead><tr>';
                    html += '<th style="width: 60px;">#</th>';
                    html += '<th>ID</th>';
                    html += '<th>Name</th>';
                    html += '<th>Codelist</th>';
                    html += '</tr></thead>';
                    html += '<tbody>';

                    data.structure.dimensions.forEach((dim, index) => {
                        html += '<tr>';
                        html += `<td class="dimension-position">${index}</td>`;
                        html += `<td><code>${dim.id || 'N/A'}</code></td>`;
                        html += `<td>${dim.name || 'N/A'}</td>`;
                        html += '<td>';

                        if (dim.codelist && dim.codelist.codes) {
                            const codesCount = Object.keys(dim.codelist.codes).length;
                            html += `<span class="codelist-badge">${codesCount} codes</span>`;

                            // Show preview of first few codes
                            const codes = Object.entries(dim.codelist.codes).slice(0, 5);
                            if (codes.length > 0) {
                                html += '<div class="codelist-preview">';
                                codes.forEach(([key, value]) => {
                                    html += `<div class="code-item"><span class="code-key">${key}</span>: ${value}</div>`;
                                });
                                if (codesCount > 5) {
                                    html += `<div class="code-item" style="color: #999; font-style: italic;">... and ${codesCount - 5} more</div>`;
                                }
                                html += '</div>';
                            }
                        } else {
                            html += '<span style="color: #999;">No codelist</span>';
                        }

                        html += '</td>';
                        html += '</tr>';
                    });

                    html += '</tbody></table>';
                }

                // Attributes Section
                if (data.structure.attributes && data.structure.attributes.length > 0) {
                    html += '<h4 style="margin: 20px 0 10px 0; color: #333;">Attributes</h4>';
                    html += '<div class="attributes-list">';

                    data.structure.attributes.forEach(attr => {
                        html += '<div class="attribute-item">';
                        html += `<span class="attribute-name">${attr.name || attr.id}</span>`;
                        html += `<span class="attribute-id">${attr.id}</span>`;
                        html += '</div>';
                    });

                    html += '</div>';
                }

                html += '</div>';
            }

            // If no data
            if (!data.flow && !data.structure) {
                html += '<div class="no-results">';
                html += '<div class="no-results-icon"></div>';
                html += '<p>No metadata available</p>';
                html += '</div>';
            }

            container.innerHTML = html;
        }

        // ========================================================================
        // DATA TAB FUNCTIONALITY
        // ========================================================================

        /**
         * Fetch and display data series
         */
        function getData() {
            const source = document.getElementById('data-source').value;
            const flow = document.getElementById('data-flow').value;
            const key = document.getElementById('data-key').value;
            const database = document.getElementById('data-database').value;

            if (!source || !flow || !key) {
                alert('Please enter source ID, flow ID, and key');
                return;
            }

            const body = { source, flow, key };
            if (database) {
                body.database = database;
            }

            // Show loading and reset views
            const prettyView = document.getElementById('data-pretty-view');
            const copyDropdown = document.getElementById('data-copy-dropdown');

            prettyView.style.display = 'block';
            copyDropdown.style.display = 'none';

            fetch(API_BASE + '/data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(body)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || `HTTP ${response.status}: ${response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                copyDropdown.style.display = 'inline-block';

                // Store response data and request params for copying
                window.dataResponseData = data;
                window.dataRequestParams = body;

                // Render chart and table
                renderDataChart(data);
                renderDataTable(data);
            })
            .catch(error => {
                prettyView.style.display = 'none';
                alert(`Error fetching data: ${error.message}`);
            });
        }

        // Variables for chart data
        let fullDatasets = null;
        let allPeriodLabels = null;

        /**
         * Extract start component from ISO period format "start/duration"
         * Examples: "2023-01/P1M" -> "2023-01", "2023-Q1/P3M" -> "2023-Q1"
         */
        function extractPeriodStart(period) {
            if (!period) return null;

            // If period contains '/', it's in ISO format "start/duration"
            if (typeof period === 'string' && period.includes('/')) {
                return period.split('/')[0].trim();
            }

            // Otherwise return as-is
            return period;
        }

        /**
         * Parse period string to JavaScript Date
         * Supports: YYYY, YYYY-MM, YYYY-MM-DD, YYYY-Qn, YYYY-Wnn
         */
        function parseToDate(periodStr) {
            if (!periodStr) return null;

            periodStr = periodStr.trim();

            // Annual: YYYY
            if (/^\d{4}$/.test(periodStr)) {
                return new Date(parseInt(periodStr), 0, 1);
            }

            // Quarterly: YYYY-Q[1-4]
            const qMatch = periodStr.match(/^(\d{4})-Q([1-4])$/);
            if (qMatch) {
                const year = parseInt(qMatch[1]);
                const quarter = parseInt(qMatch[2]);
                return new Date(year, (quarter - 1) * 3, 1);
            }

            // Monthly: YYYY-MM
            const mMatch = periodStr.match(/^(\d{4})-(\d{2})$/);
            if (mMatch) {
                return new Date(parseInt(mMatch[1]), parseInt(mMatch[2]) - 1, 1);
            }

            // Weekly: YYYY-W[01-53]
            const wMatch = periodStr.match(/^(\d{4})-W(\d{2})$/);
            if (wMatch) {
                const year = parseInt(wMatch[1]);
                const week = parseInt(wMatch[2]);
                const date = new Date(year, 0, 1);
                date.setDate(date.getDate() + (week - 1) * 7);
                return date;
            }

            // Daily: YYYY-MM-DD
            const dMatch = periodStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (dMatch) {
                return new Date(parseInt(dMatch[1]), parseInt(dMatch[2]) - 1, parseInt(dMatch[3]));
            }

            // Try standard Date parsing
            const date = new Date(periodStr);
            return isNaN(date.getTime()) ? null : date;
        }

        function renderDataChart(data) {
            const chartDiv = document.getElementById('data-chart');

            // Parse SDMX data structure into Plotly traces
            const traces = [];
            const allLabelsSet = new Set();
            const periodToDateMap = new Map();

            if (data.data && Array.isArray(data.data)) {
                const seriesDataMaps = [];
                data.data.forEach((series, index) => {
                    if (series.obs && Array.isArray(series.obs)) {
                        const dataMap = new Map();
                        series.obs.forEach(obs => {
                            // Extract start from ISO period format (start/duration)
                            let period = obs.period;
                            if (period) {
                                period = extractPeriodStart(period);

                                // Parse to date and store mapping
                                const dateObj = parseToDate(period);
                                if (dateObj) {
                                    periodToDateMap.set(period, dateObj);
                                }
                            }
                            const value = parseFloat(obs.value);
                            if (!isNaN(value) && period) {
                                dataMap.set(period, value);
                                allLabelsSet.add(period);
                            }
                        });
                        if (dataMap.size > 0) {
                            seriesDataMaps.push({ key: series.key || `Series ${index + 1}`, dataMap });
                        }
                    }
                });

                // Sort labels by date
                const sortedLabels = Array.from(allLabelsSet).sort((a, b) => {
                    const dateA = periodToDateMap.get(a);
                    const dateB = periodToDateMap.get(b);
                    if (dateA && dateB) {
                        return dateA - dateB;
                    }
                    return a.localeCompare(b);
                });

                // Check if all periods were successfully parsed to dates
                const allParsed = sortedLabels.every(label => periodToDateMap.has(label));

                seriesDataMaps.forEach((seriesInfo) => {
                    // Use Date objects if all periods parsed, otherwise use strings
                    const xValues = sortedLabels.map(label =>
                        allParsed && periodToDateMap.has(label)
                            ? periodToDateMap.get(label)
                            : label
                    );
                    const yValues = sortedLabels.map(label => seriesInfo.dataMap.get(label) ?? null);

                    traces.push({
                        x: xValues,
                        y: yValues,
                        mode: 'lines+markers',
                        name: seriesInfo.key,
                        connectgaps: true,
                        hovertemplate: allParsed
                            ? '%{x|%Y-%m-%d}<br>%{y}<extra>' + seriesInfo.key + '</extra>'
                            : '%{x}<br>%{y}<extra>' + seriesInfo.key + '</extra>'
                    });
                });

                fullDatasets = traces;
                allPeriodLabels = Array.from(sortedLabels);

                // Store whether using dates
                chartDiv.dataset.useDateAxis = allParsed ? 'true' : 'false';
            }

            if (!fullDatasets || fullDatasets.length === 0 || !allPeriodLabels || allPeriodLabels.length === 0) {
                chartDiv.innerHTML = '<div style="color:#666; text-align:center; padding-top: 40px;">No data available to display</div>';
                return;
            }


            // Create Plotly chart with rangeslider
            createPlotlyChart(data, allPeriodLabels, fullDatasets);
        }

        function createPlotlyChart(data, labels, traces) {
            const chartDiv = document.getElementById('data-chart');

            // Check if Plotly is loaded
            if (typeof Plotly === 'undefined') {
                chartDiv.innerHTML = '<div style="color:#cc0000; text-align:center; padding-top: 40px;">Error: Plotly library failed to load. Please refresh the page.</div>';
                console.error('Plotly is not defined. Make sure the Plotly script is loaded before calling this function.');
                return;
            }

            // Check if using date axis
            const useDateAxis = chartDiv.dataset.useDateAxis === 'true';

            const layout = {
                title: {
                    text: `${data.ref || 'Data'} - ${(data.query && data.query.key) ? data.query.key : ''}`,
                    font: { size: 16, color: '#003D6D' }
                },
                xaxis: {
                    title: {
                        text: 'Time Period',
                        font: { size: 14, color: '#003D6D' }
                    },
                    type: useDateAxis ? 'date' : 'category',
                    tickangle: useDateAxis ? 0 : -45,
                    tickfont: { size: 11 },
                    showgrid: true,
                    gridcolor: '#e0e0e0',
                    gridwidth: 1,
                    showline: true,
                    linecolor: '#003D6D',
                    linewidth: 2,
                    rangeslider: {
                        visible: true,
                        bgcolor: '#f8f9fa',
                        bordercolor: '#003D6D',
                        borderwidth: 1,
                        thickness: 0.1
                    },
                    automargin: true
                },
                yaxis: {
                    title: {
                        text: 'Value',
                        font: { size: 14, color: '#003D6D' }
                    },
                    showgrid: true,
                    gridcolor: '#e0e0e0',
                    gridwidth: 1,
                    showline: true,
                    linecolor: '#003D6D',
                    linewidth: 2,
                    zeroline: true,
                    zerolinecolor: '#999',
                    zerolinewidth: 1
                },
                margin: { l: 60, r: 30, t: 60, b: useDateAxis ? 80 : 100 },
                legend: {
                    orientation: 'h',
                    x: 0.5,
                    xanchor: 'center',
                    y: -0.2,
                    bgcolor: 'rgba(255,255,255,0.8)',
                    bordercolor: '#e0e0e0',
                    borderwidth: 1
                },
                hovermode: 'x unified',
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#f8f9fa'
            };

            // Add date-specific formatting
            if (useDateAxis) {
                layout.xaxis.tickformat = '%Y-%m-%d';
                layout.xaxis.hoverformat = '%Y-%m-%d';
            }

            const config = { responsive: true, displayModeBar: true };

            try {
                Plotly.react(chartDiv, traces, layout, config);

                // Force immediate resize to ensure correct initial size
                setTimeout(() => {
                    try {
                        Plotly.Plots.resize(chartDiv);
                    } catch (e) {
                        console.warn('Initial Plotly resize failed:', e);
                    }
                }, 50);

                // Setup resize observer for future size changes
                setupChartResizeObserver();
            } catch (error) {
                chartDiv.innerHTML = '<div style="color:#cc0000; text-align:center; padding-top: 40px;">Error rendering chart: ' + error.message + '</div>';
                console.error('Plotly rendering error:', error);
            }
        }

        function setupChartResizeObserver() {
            const chartDiv = document.getElementById('data-chart');
            const container = chartDiv?.parentElement; // .chart-container
            if (!chartDiv || !container || typeof Plotly === 'undefined') return;

            // Avoid duplicate observers
            if (chartDiv._resizeObserver) {
                return;
            }

            // Debounce to avoid excessive resize calls
            let resizeTimeout = null;
            const triggerResize = () => {
                if (resizeTimeout) clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    try {
                        Plotly.Plots.resize(chartDiv);
                    } catch (e) {
                        console.warn('Plotly resize failed:', e);
                    }
                }, 100);
            };

            // Observe container size
            try {
                const ro = new ResizeObserver(() => triggerResize());
                ro.observe(container);
                // Store observer for cleanup if needed
                chartDiv._resizeObserver = ro;
            } catch (e) {
                console.warn('ResizeObserver not available:', e);
            }

            // Also listen to window resize
            const handleWindowResize = () => triggerResize();
            window.addEventListener('resize', handleWindowResize, { passive: true });
            chartDiv._windowResizeHandler = handleWindowResize;
        }



        function renderDataTable(data) {
            const tableContent = document.getElementById('table-content');

            if (!data.data || !Array.isArray(data.data) || data.data.length === 0) {
                tableContent.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No data available to display</p>';
                return;
            }

            // Collect all unique periods across all series
            const allPeriods = new Set();
            data.data.forEach(series => {
                if (series.obs && Array.isArray(series.obs)) {
                    series.obs.forEach(obs => {
                        // Extract start from ISO period format (start/duration)
                        let period = obs.period;
                        if (period) {
                            period = extractPeriodStart(period);
                            allPeriods.add(period);
                        }
                    });
                }
            });

            const sortedPeriods = Array.from(allPeriods).sort();

            // Create table structure
            let tableHTML = '<table class="data-table"><thead><tr>';
            tableHTML += '<th>Period</th>';

            // Add column for each series
            data.data.forEach((series, index) => {
                const seriesKey = series.key || `Series ${index + 1}`;
                tableHTML += `<th>${seriesKey}</th>`;
            });

            tableHTML += '</tr></thead><tbody>';

            // Create rows for each period
            sortedPeriods.forEach(period => {
                tableHTML += `<tr><td><strong>${period}</strong></td>`;

                // Add value for each series
                data.data.forEach(series => {
                    let value = '-';
                    if (series.obs && Array.isArray(series.obs)) {
                        // Find observation by comparing extracted start
                        const obs = series.obs.find(o => extractPeriodStart(o.period) === period);
                        if (obs && obs.value !== undefined && obs.value !== null) {
                            // Format number with appropriate decimals
                            const numValue = parseFloat(obs.value);
                            if (!isNaN(numValue)) {
                                value = numValue.toLocaleString(undefined, {
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 6
                                });
                            }
                        }
                    }
                    tableHTML += `<td>${value}</td>`;
                });

                tableHTML += '</tr>';
            });

            tableHTML += '</tbody></table>';

            // Add summary information
            const totalObs = data.data.reduce((sum, series) => {
                return sum + (series.obs ? series.obs.length : 0);
            }, 0);

            tableHTML += `<div class="table-summary">`;
            tableHTML += `<strong>Summary:</strong> `;
            tableHTML += `${data.data.length} series, `;
            tableHTML += `${sortedPeriods.length} periods, `;
            tableHTML += `${totalObs} total observations`;
            tableHTML += `</div>`;

            tableContent.innerHTML = tableHTML;
        }

        // ========================================================================
        // KEY BUILDER FUNCTIONALITY
        // ========================================================================

        // Key Builder functionality
        let currentStructure = null;
        let dimensionValues = {};
        let keyBuilderCallbackUrl = null; // Callback URL for sending key data

        // Quick key input state
        let currentDimensionIndex = 0;
        let selectedAutocompleteIndex = -1;


        function switchKeyInputMode(mode) {
            const guidedMode = document.getElementById('dimensions-container');
            const quickMode = document.getElementById('quick-key-container');
            const hierarchyMode = document.getElementById('hierarchy-key-container');
            const toggleButtons = document.querySelectorAll('.key-input-mode-toggle button');

            toggleButtons.forEach(btn => btn.classList.remove('active'));

            // Hide all modes
            guidedMode.style.display = 'none';
            quickMode.style.display = 'none';
            hierarchyMode.style.display = 'none';

            if (mode === 'guided') {
                guidedMode.style.display = 'block';
                toggleButtons[0].classList.add('active');
            } else if (mode === 'quick') {
                quickMode.style.display = 'block';
                toggleButtons[1].classList.add('active');

                // Focus on quick input
                setTimeout(() => {
                    document.getElementById('quick-key-input').focus();
                }, 100);
            } else if (mode === 'hierarchy') {
                hierarchyMode.style.display = 'block';
                toggleButtons[2].classList.add('active');

                // Initialize hierarchy builder if structure is loaded
                if (currentStructure && currentStructure.dimensions) {
                    renderHierarchyBuilder();
                }
            }
        }


        // Hierarchy Builder State
        let hierarchySelections = {};
        let hierarchyExpanded = {};


        // ========================================================================
        // HIERARCHY BUILDER FUNCTIONS
        // ========================================================================

        /**
         * Render the hierarchy builder as a true tree:
         * Level 1 = Dimension 1 values
         * Level 2 = Dimension 2 values (children of each Dimension 1 value)
         * Level 3 = Dimension 3 values (children of each Dimension 2 value)
         * etc.
         */
        function renderHierarchyBuilder() {
            if (!currentStructure || !currentStructure.dimensions) return;

            const container = document.getElementById('hierarchy-builder-content');
            let html = '';

            // Progress info
            const selectedPath = getHierarchyPath();
            const currentLevel = selectedPath.length;
            const totalLevels = currentStructure.dimensions.length;

            html += '<div class="tree-progress">';
            html += '<div class="tree-progress-label">Key Building Progress</div>';
            html += '<div class="tree-progress-bar-container">';
            const progress = (currentLevel / totalLevels) * 100;
            html += `<div class="tree-progress-bar" style="width: ${progress}%"></div>`;
            html += '</div>';
            html += `<div class="tree-progress-text">${currentLevel} of ${totalLevels} dimensions selected</div>`;
            html += '</div>';

            // Show current path (breadcrumb)
            if (selectedPath.length > 0) {
                html += '<div class="hierarchy-breadcrumb">';
                selectedPath.forEach((item, index) => {
                    const dim = currentStructure.dimensions[index];
                    html += `<div class="hierarchy-breadcrumb-item" onclick="navigateToLevel(${index})" title="${dim.name || dim.id}">`;
                    html += `<strong>${dim.id}:</strong> ${escapeHtml(item.label)}`;
                    html += '</div>';
                    if (index < selectedPath.length - 1) {
                        html += '<span class="hierarchy-breadcrumb-separator"></span>';
                    }
                });
                html += '</div>';
            }

            // Current dimension to select
            const currentDimension = currentStructure.dimensions[currentLevel];

            if (currentDimension) {
                html += '<div class="hierarchy-dimension">';
                html += '<div class="hierarchy-dimension-header">';
                html += '<div class="hierarchy-dimension-info">';
                html += `<h4>Select ${currentDimension.name || currentDimension.id}</h4>`;
                html += `<div class="hierarchy-dimension-id">Dimension ${currentLevel + 1} of ${totalLevels}: ${currentDimension.id}</div>`;
                html += '</div>';
                html += '</div>';

                // Search box
                if (currentDimension.codelist && currentDimension.codelist.codes) {
                    html += '<div class="hierarchy-search">';
                    html += `<input type="text" id="hierarchy-search-input" placeholder="Search codes..." onkeyup="filterHierarchyTree(this.value)" />`;
                    html += '</div>';

                    const codes = currentDimension.codelist.codes;
                    const codeEntries = Object.entries(codes);

                    html += `<div class="hierarchy-stats"> ${codeEntries.length} available codes</div>`;

                    // Render tree of available codes
                    html += '<div class="hierarchy-tree" id="hierarchy-tree-root">';

                    // Add wildcard option
                    html += renderHierarchyTreeNode(currentLevel, '+', 'All values (wildcard)', true);

                    // Add all code options
                    codeEntries.sort((a, b) => a[0].localeCompare(b[0])).forEach(([code, label]) => {
                        html += renderHierarchyTreeNode(currentLevel, code, label, false);
                    });

                    html += '</div>';
                } else {
                    // No codelist - text input
                    html += '<div style="padding: 15px; background: white; border-radius: 6px;">';
                    html += `<input type="text" id="hierarchy-manual-input" placeholder="Enter value or use + for wildcard" style="width: 100%; padding: 12px; border: 1px solid #003D6D; border-radius: 4px; font-size: 14px;" />`;
                    html += '<div style="margin-top: 10px; display: flex; gap: 10px;">';
                    html += '<button onclick="selectManualValue()" style="flex: 1;">Confirm Value</button>';
                    html += '<button onclick="selectHierarchyValue(\'+\')" style="flex: 1; background: #ff9800; border-color: #ff9800;">Use Wildcard (+)</button>';
                    html += '</div>';
                    html += '</div>';
                }

                html += '</div>';
            } else {
                // All dimensions selected - show completion
                html += '<div class="hierarchy-dimension" style="background: #e8f5e9; border-color: #4caf50;">';
                html += '<div class="hierarchy-dimension-header">';
                html += '<div class="hierarchy-dimension-info">';
                html += '<h4><span class="material-symbols-outlined" style="color: #4caf50;">check_circle</span> Key Complete!</h4>';
                html += '<div class="hierarchy-dimension-id">All dimensions have been selected</div>';
                html += '</div>';
                html += '</div>';
                html += '<div style="padding: 20px; text-align: center;">';
                html += '<p style="color: #4caf50; font-size: 16px; margin-bottom: 15px;">Your SDMX key has been successfully built.</p>';
                html += '<button onclick="navigateToLevel(0)" style="background: #003D6D; border-color: #003D6D;"><span class="material-symbols-outlined">restart_alt</span> Start Over</button>';
                html += '</div>';
                html += '</div>';
            }

            container.innerHTML = html;
            updateGeneratedKey();
        }

        /**
         * Render a single tree node (represents one code option at current dimension level)
         */
        function renderHierarchyTreeNode(level, code, label, isWildcard) {
            const cssClass = isWildcard ? 'hierarchy-node-wildcard' : 'hierarchy-node-code';

            let html = `<div class="hierarchy-node ${cssClass}" onclick="selectHierarchyValue('${escapeHtml(code)}')">`;
            html += '<div class="hierarchy-node-content">';

            if (isWildcard) {
                html += '<span class="material-symbols-outlined" style="color: #ff9800; margin-right: 12px;">all_inclusive</span>';
            }

            html += '<div class="hierarchy-node-label">';
            html += `<div class="hierarchy-node-code">${escapeHtml(code)}</div>`;
            html += `<div class="hierarchy-node-name">${escapeHtml(label)}</div>`;
            html += '</div>';

            // Show arrow indicating there are more levels
            const currentPath = getHierarchyPath();
            if (currentPath.length < currentStructure.dimensions.length - 1) {
                html += '<span class="material-symbols-outlined" style="margin-left: auto; color: #666;">arrow_forward</span>';
            } else {
                html += '<span class="material-symbols-outlined" style="margin-left: auto; color: #4caf50;">check</span>';
            }

            html += '</div>';
            html += '</div>';

            return html;
        }

        /**
         * Get the current selection path as an array
         */
        function getHierarchyPath() {
            const path = [];
            for (let i = 0; i < currentStructure.dimensions.length; i++) {
                const dim = currentStructure.dimensions[i];
                if (hierarchySelections[dim.id]) {
                    const code = hierarchySelections[dim.id];
                    const label = code === '+' ? 'All values' :
                                  (dim.codelist?.codes?.[code] || code);
                    path.push({ code, label, dimensionId: dim.id });
                } else {
                    break;
                }
            }
            return path;
        }

        /**
         * Navigate back to a specific level in the tree
         */
        function navigateToLevel(level) {
            // Clear selections from this level onwards
            for (let i = level; i < currentStructure.dimensions.length; i++) {
                const dim = currentStructure.dimensions[i];
                delete hierarchySelections[dim.id];
            }
            renderHierarchyBuilder();
        }

        /**
         * Select a value at the current dimension level
         */
        function selectHierarchyValue(code) {
            const currentPath = getHierarchyPath();
            const currentLevel = currentPath.length;

            if (currentLevel < currentStructure.dimensions.length) {
                const currentDimension = currentStructure.dimensions[currentLevel];
                hierarchySelections[currentDimension.id] = code;
                renderHierarchyBuilder();
            }
        }

        /**
         * Select manual input value
         */
        function selectManualValue() {
            const input = document.getElementById('hierarchy-manual-input');
            if (input && input.value.trim()) {
                selectHierarchyValue(input.value.trim());
            }
        }

        /**
         * Filter the tree display based on search text
         */
        function filterHierarchyTree(searchText) {
            const tree = document.getElementById('hierarchy-tree-root');
            if (!tree) return;

            const search = searchText.toLowerCase();
            const nodes = tree.querySelectorAll('.hierarchy-node');

            if (!search) {
                // Show all nodes
                nodes.forEach(node => {
                    node.style.display = '';
                });
                return;
            }

            // Filter nodes
            nodes.forEach(node => {
                const codeEl = node.querySelector('.hierarchy-node-code');
                const nameEl = node.querySelector('.hierarchy-node-name');

                if (codeEl && nameEl) {
                    const code = codeEl.textContent.toLowerCase();
                    const name = nameEl.textContent.toLowerCase();

                    if (code.includes(search) || name.includes(search)) {
                        node.style.display = '';
                    } else {
                        node.style.display = 'none';
                    }
                }
            });
        }

        function loadKeyBuilderStructure() {
            const source = document.getElementById('kb-source').value;
            const flow = document.getElementById('kb-flow').value;
            const database = document.getElementById('kb-database').value;

            if (!source || !flow) {
                alert('Please enter both source ID and flow ID');
                return;
            }

            const body = { source, flow };
            if (database) {
                body.database = database;
            }

            // Show loading
            const dimensionsContainer = document.getElementById('dimensions-container');
            const dimensionsList = document.getElementById('dimensions-list');
            dimensionsList.innerHTML = '<p style="color: #666;">Loading structure...</p>';
            dimensionsContainer.style.display = 'block';

            fetch(API_BASE + '/meta', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(body)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || `HTTP ${response.status}: ${response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.structure && data.structure.dimensions) {
                    currentStructure = data.structure;
                    dimensionValues = {};
                    hierarchySelections = {}; // Reset hierarchy selections
                    hierarchyExpanded = {}; // Reset hierarchy expanded state
                    renderDimensionInputs(data.structure.dimensions);

                    // Show mode toggle and setup quick input
                    document.getElementById('key-input-mode-toggle').style.display = 'flex';
                    setupQuickKeyInput();

                    // Show Generated SDMX Key section and render action buttons
                    document.getElementById('built-key-container').style.display = 'block';
                    renderKeyActions();

                    // Initialize hierarchy builder
                    renderHierarchyBuilder();
                } else {
                    throw new Error('No structure dimensions found');
                }
            })
            .catch(error => {
                dimensionsList.innerHTML = `<p style="color: #c33;">Error: ${error.message}</p>`;
            });
        }

        function renderDimensionInputs(dimensions) {
            const dimensionsList = document.getElementById('dimensions-list');
            dimensionsList.innerHTML = '';

            dimensions.forEach((dimension, index) => {
                const dimRow = document.createElement('div');
                dimRow.className = 'dimension-row';

                // Dimension label
                const label = document.createElement('div');
                label.className = 'dimension-label';
                label.innerHTML = `
                    <div>${dimension.name || dimension.id}</div>
                    <span class="dim-id">${dimension.id}</span>
                `;

                // Dimension input
                const inputDiv = document.createElement('div');
                inputDiv.className = 'dimension-input';

                if (dimension.codelist && dimension.codelist.codes) {
                    // Create select dropdown with codes
                    const select = document.createElement('select');
                    select.id = `dim-${dimension.id}`;
                    select.dataset.dimensionIndex = index;

                    // Add empty option
                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = '-- Select a value --';
                    select.appendChild(emptyOption);

                    // Add wildcard option
                    const wildcardOption = document.createElement('option');
                    wildcardOption.value = '+';
                    wildcardOption.textContent = '+ (All values)';
                    select.appendChild(wildcardOption);

                    // Add all codes initially
                    const codes = dimension.codelist.codes;
                    Object.keys(codes).sort().forEach(code => {
                        const option = document.createElement('option');
                        option.value = code;
                        option.textContent = `${code} - ${codes[code]}`;
                        select.appendChild(option);
                    });

                    // Store full codelist for reference
                    select.dataset.fullCodelist = JSON.stringify(codes);

                    select.addEventListener('change', async () => {
                        updateGeneratedKey();
                    });
                    inputDiv.appendChild(select);

                    // Add help text (will be updated dynamically)
                    const helpText = document.createElement('div');
                    helpText.className = 'help-text';
                    helpText.id = `help-${dimension.id}`;
                    helpText.textContent = `${Object.keys(codes).length} available codes`;
                    inputDiv.appendChild(helpText);

                } else {
                    // Create text input with wildcard button
                    const inputWrapper = document.createElement('div');
                    inputWrapper.style.display = 'flex';
                    inputWrapper.style.gap = '10px';

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = `dim-${dimension.id}`;
                    input.dataset.dimensionIndex = index;
                    input.placeholder = 'Enter value or leave empty';
                    input.addEventListener('input', async () => {
                        updateGeneratedKey();
                    });

                    const wildcardBtn = document.createElement('button');
                    wildcardBtn.className = 'wildcard-btn';
                    wildcardBtn.textContent = 'Use +';
                    wildcardBtn.onclick = async (e) => {
                        e.preventDefault();
                        input.value = '+';
                        updateGeneratedKey();
                    };

                    inputWrapper.appendChild(input);
                    inputWrapper.appendChild(wildcardBtn);
                    inputDiv.appendChild(inputWrapper);

                    const helpText = document.createElement('div');
                    helpText.className = 'help-text';
                    helpText.id = `help-${dimension.id}`;
                    helpText.textContent = 'No codelist available - enter value manually';
                    inputDiv.appendChild(helpText);
                }

                dimRow.appendChild(label);
                dimRow.appendChild(inputDiv);
                dimensionsList.appendChild(dimRow);
            });

            updateGeneratedKey();
        }

        function updateGeneratedKey() {
            if (!currentStructure || !currentStructure.dimensions) {
                return;
            }

            const keyParts = [];

            // Check which mode is active
            const hierarchyMode = document.getElementById('hierarchy-key-container');
            const isHierarchyMode = hierarchyMode && hierarchyMode.style.display !== 'none';

            currentStructure.dimensions.forEach(dimension => {
                let value = '';

                if (isHierarchyMode && hierarchySelections.hasOwnProperty(dimension.id)) {
                    // Use hierarchy builder selection
                    value = hierarchySelections[dimension.id];
                } else {
                    // Use guided mode input
                    const input = document.getElementById(`dim-${dimension.id}`);
                    if (input) {
                        value = input.value.trim();
                    }
                }

                keyParts.push(value || '');
            });

            const generatedKey = keyParts.join('.');
            document.getElementById('generated-key').textContent = generatedKey || '-';
        }


        function copyKeyToClipboard(btn) {
            const keyText = document.getElementById('generated-key').textContent;
            if (keyText === '-') {
                alert('Please build a key first');
                return;
            }

            navigator.clipboard.writeText(keyText).then(() => {
                // Show temporary success message
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="material-symbols-outlined">check</span> Copied!';
                btn.style.background = '#4caf50';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function useKeyInDataTab() {
            const keyText = document.getElementById('generated-key').textContent;
            if (keyText === '-') {
                alert('Please build a key first');
                return;
            }

            // Copy values to data tab
            document.getElementById('data-source').value = document.getElementById('kb-source').value;
            document.getElementById('data-flow').value = document.getElementById('kb-flow').value;
            document.getElementById('data-database').value = document.getElementById('kb-database').value;
            document.getElementById('data-key').value = keyText;

            // Switch to data tab
            switchTab('data');

            // Highlight the data tab briefly
            const dataTab = Array.from(document.querySelectorAll('.tab')).find(tab =>
                tab.textContent === 'Data'
            );
            if (dataTab) {
                dataTab.style.background = '#00cc00';
                dataTab.style.color = 'white';
                setTimeout(() => {
                    dataTab.style.background = '';
                    dataTab.style.color = '';
                }, 1000);
            }
        }

        function useKeyInCompareTab() {
            const keyText = document.getElementById('generated-key').textContent;
            if (keyText === '-') {
                alert('Please build a key first');
                return;
            }

            // Copy values to compare tab
            document.getElementById('compare-source').value = document.getElementById('kb-source').value;
            document.getElementById('compare-flow').value = document.getElementById('kb-flow').value;
            document.getElementById('compare-database').value = document.getElementById('kb-database').value;
            document.getElementById('compare-key').value = keyText;

            // Switch to compare tab
            switchTab('compare');

            // Highlight the compare tab briefly
            const compareTab = Array.from(document.querySelectorAll('.tab')).find(tab =>
                tab.textContent === 'Compare'
            );
            if (compareTab) {
                compareTab.style.background = '#00cc00';
                compareTab.style.color = 'white';
                setTimeout(() => {
                    compareTab.style.background = '';
                    compareTab.style.color = '';
                }, 1000);
            }
        }

        function resetKeyBuilder() {
            if (!currentStructure || !currentStructure.dimensions) {
                return;
            }

            // Reset guided mode inputs
            currentStructure.dimensions.forEach(dimension => {
                const input = document.getElementById(`dim-${dimension.id}`);
                if (input) {
                    input.value = '';
                }
            });

            // Reset quick key input
            const quickInput = document.getElementById('quick-key-input');
            if (quickInput) {
                quickInput.value = '';
            }

            // Reset hierarchy selections
            hierarchySelections = {};

            // Re-render hierarchy builder if in hierarchy mode
            const hierarchyMode = document.getElementById('hierarchy-key-container');
            if (hierarchyMode && hierarchyMode.style.display !== 'none') {
                renderHierarchyBuilder();
            }

            updateGeneratedKey();
        }

        function renderKeyActions() {
            const keyActionsDiv = document.getElementById('key-actions');
            if (!keyActionsDiv) return;

            if (keyBuilderCallbackUrl) {
                // Render Send button for callback mode
                keyActionsDiv.innerHTML = `
                    <button onclick="sendKeyToCallback()"><span class="material-symbols-outlined">send</span> Send</button>
                    <button onclick="resetKeyBuilder()"><span class="material-symbols-outlined">refresh</span> Reset</button>
                `;
            } else {
                // Render regular buttons
                keyActionsDiv.innerHTML = `
                    <button onclick="copyKeyToClipboard(this)"><span class="material-symbols-outlined">content_copy</span> Copy Key</button>
                    <button onclick="useKeyInDataTab()"><span class="material-symbols-outlined">arrow_forward</span> Use in Data Tab</button>
                    <button onclick="useKeyInCompareTab()"><span class="material-symbols-outlined">compare_arrows</span> Use in Compare Tab</button>
                    <button onclick="resetKeyBuilder()"><span class="material-symbols-outlined">refresh</span> Reset</button>
                `;
            }
        }

        async function sendKeyToCallback() {
            const keyText = document.getElementById('generated-key').textContent;
            if (keyText === '-') {
                alert('Please build a key first');
                return;
            }

            if (!keyBuilderCallbackUrl) {
                alert('No callback URL configured');
                return;
            }

            const data = {
                source: document.getElementById('kb-source').value,
                flow: document.getElementById('kb-flow').value,
                database: document.getElementById('kb-database').value,
                key: keyText
            };

            try {
                const response = await fetch(keyBuilderCallbackUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // Show success message
                alert('Key data sent successfully!');

                // Optionally close window if opened as popup
                if (window.opener) {
                    window.close();
                }
            } catch (error) {
                alert('Failed to send data: ' + error.message);
                console.error('Error sending to callback:', error);
            }
        }

        function setupQuickKeyInput() {
            const quickInput = document.getElementById('quick-key-input');
            const dropdown = document.getElementById('autocomplete-dropdown');

            if (!quickInput || !dropdown) return;

            quickInput.addEventListener('input', async function(e) {
                const value = this.value;
                const parts = value.split('.');
                currentDimensionIndex = parts.length - 1;

                const currentPart = parts[currentDimensionIndex] || '';

                // Load autocomplete for current dimension
                await loadQuickKeyAutocomplete(parts, currentPart);
            });

            quickInput.addEventListener('keydown', function(e) {
                const dropdown = document.getElementById('autocomplete-dropdown');
                if (!dropdown.classList.contains('show')) {
                    if (e.key === 'Tab' || e.key === '.') {
                        // Move to next dimension
                        if (e.key === 'Tab') {
                            e.preventDefault();
                            if (!this.value.endsWith('.')) {
                                this.value += '.';
                                this.dispatchEvent(new Event('input'));
                            }
                        }
                    }
                    return;
                }

                const items = dropdown.querySelectorAll('.autocomplete-item');

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedAutocompleteIndex = Math.min(selectedAutocompleteIndex + 1, items.length - 1);
                    updateAutocompleteSelection(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedAutocompleteIndex = Math.max(selectedAutocompleteIndex - 1, -1);
                    updateAutocompleteSelection(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedAutocompleteIndex >= 0 && items[selectedAutocompleteIndex]) {
                        selectAutocompleteItem(items[selectedAutocompleteIndex]);
                    }
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                    selectedAutocompleteIndex = -1;
                } else if (e.key === 'Tab' || e.key === '.') {
                    if (selectedAutocompleteIndex >= 0 && items[selectedAutocompleteIndex]) {
                        e.preventDefault();
                        selectAutocompleteItem(items[selectedAutocompleteIndex]);
                    }
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!quickInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                    selectedAutocompleteIndex = -1;
                }
            });
        }

        async function loadQuickKeyAutocomplete(parts, currentPart) {
            const dropdown = document.getElementById('autocomplete-dropdown');

            if (!currentStructure || !currentStructure.dimensions) {
                dropdown.classList.remove('show');
                return;
            }

            const dimIndex = parts.length - 1;
            if (dimIndex < 0 || dimIndex >= currentStructure.dimensions.length) {
                dropdown.classList.remove('show');
                return;
            }

            const dimension = currentStructure.dimensions[dimIndex];

            // Get codes for this dimension from structure only (no availability filtering)
            let codes = {};
            if (dimension.codelist && dimension.codelist.codes) {
                codes = dimension.codelist.codes;
            }


            // Filter codes based on current input
            const matchingCodes = Object.keys(codes).filter(code =>
                code.toLowerCase().startsWith(currentPart.toLowerCase()) ||
                codes[code].toLowerCase().includes(currentPart.toLowerCase())
            );

            if (matchingCodes.length === 0) {
                dropdown.classList.remove('show');
                return;
            }

            // Render dropdown
            dropdown.innerHTML = '';

            // Add wildcard option
            if ('+'.startsWith(currentPart.toLowerCase()) || currentPart === '') {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.innerHTML = `<span class="code">+</span><span class="description">All values</span>`;
                item.dataset.code = '+';
                item.addEventListener('click', () => selectAutocompleteItem(item));
                dropdown.appendChild(item);
            }

            // Add matching codes
            matchingCodes.sort().forEach(code => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.innerHTML = `<span class="code">${code}</span><span class="description">${codes[code]}</span>`;
                item.dataset.code = code;
                item.addEventListener('click', () => selectAutocompleteItem(item));
                dropdown.appendChild(item);
            });

            selectedAutocompleteIndex = -1;
            dropdown.classList.add('show');
        }

        function updateAutocompleteSelection(items) {
            items.forEach((item, index) => {
                if (index === selectedAutocompleteIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function selectAutocompleteItem(item) {
            const code = item.dataset.code;
            const quickInput = document.getElementById('quick-key-input');
            const parts = quickInput.value.split('.');

            // Replace the current part being typed
            parts[parts.length - 1] = code;

            // Add a dot if not at the last dimension
            if (parts.length < currentStructure.dimensions.length) {
                quickInput.value = parts.join('.') + '.';
            } else {
                quickInput.value = parts.join('.');
            }

            // Hide dropdown
            const dropdown = document.getElementById('autocomplete-dropdown');
            dropdown.classList.remove('show');
            selectedAutocompleteIndex = -1;

            // Update generated key display
            document.getElementById('generated-key').textContent = quickInput.value || '-';

            // Trigger input event to load next dimension's autocomplete
            quickInput.dispatchEvent(new Event('input'));
            quickInput.focus();
        }

        // Autocomplete helper functions
        function updateDatalist(datalistId, options) {
            const datalist = document.getElementById(datalistId);
            datalist.innerHTML = '';
            options.forEach(option => {
                const optionElement = document.createElement('option');
                // Support both simple strings and {value, label} objects
                if (typeof option === 'string') {
                    optionElement.value = option;
                } else {
                    optionElement.value = option.value;
                    if (option.label) {
                        optionElement.label = option.label;
                        // Set textContent for better search experience
                        optionElement.textContent = option.label;
                    }
                }
                datalist.appendChild(optionElement);
            });
        }

        // Helper to create searchable option with ID, name, and description
        function createOption(item) {
            const id = item.id || item.ref || item.name || '';
            const name = item.name || '';
            const description = item.description || item.label || '';

            // Create a descriptive label
            let label = id;
            if (name && name !== id) {
                label = `${id} - ${name}`;
            }
            if (description && description !== name && description !== id) {
                // Truncate long descriptions
                const maxLength = 100;
                const cleanDesc = description.replace(/<[^>]*>/g, '').trim();
                const truncDesc = cleanDesc.length > maxLength
                    ? cleanDesc.substring(0, maxLength) + '...'
                    : cleanDesc;
                if (truncDesc) {
                    label = `${label} (${truncDesc})`;
                }
            }

            return { value: id, label: label };
        }

        // ========================================================================
        // AUTOCOMPLETE FUNCTIONALITY
        // ========================================================================

        async function loadSources() {
            try {
                const response = await fetch(API_BASE + '/sources', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                if (response.ok) {
                    const sources = await response.json();
                    const sourceOptions = sources.map(s => createOption(s));
                    updateDatalist('sources-list', sourceOptions);
                }
            } catch (error) {
                console.error('Failed to load sources:', error);
            }
        }

        async function loadDatabases(sourceId, datalistId) {
            if (!sourceId) return;

            try {
                const response = await fetch(API_BASE + '/databases', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ source: sourceId })
                });

                if (response.ok) {
                    const databases = await response.json();
                    const databaseOptions = databases.map(d => createOption(d));
                    updateDatalist(datalistId, databaseOptions);
                }
            } catch (error) {
                console.error('Failed to load databases:', error);
            }
        }

        async function loadFlows(sourceId, datalistId, database = '') {
            if (!sourceId) return;

            try {
                const body = { source: sourceId };
                if (database) {
                    body.database = database;
                }

                const response = await fetch(API_BASE + '/flows', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body)
                });

                if (response.ok) {
                    const flows = await response.json();
                    const flowOptions = flows.map(f => createOption(f));
                    updateDatalist(datalistId, flowOptions);
                }
            } catch (error) {
                console.error('Failed to load flows:', error);
            }
        }

        /**
         * Setup autocomplete listeners for source/database/flow fields
         */
        function setupAutocomplete() {
            // Debounce timers for each source field
            const debounceTimers = {};

            // Helper function to attach both input and change events with debouncing
            const attachSourceListeners = (sourceId, databasesListId, flowsListId) => {
                const element = document.getElementById(sourceId);
                if (!element) return;

                // Debounced handler for 'input' event (while typing)
                const inputHandler = function() {
                    const value = this.value;

                    // Clear existing timer for this element
                    if (debounceTimers[sourceId]) {
                        clearTimeout(debounceTimers[sourceId]);
                    }

                    // Set new timer (300ms delay)
                    debounceTimers[sourceId] = setTimeout(() => {
                        loadDatabases(value, databasesListId);
                        loadFlows(value, flowsListId);
                    }, 300);
                };

                // Immediate handler for 'change' event (when selecting from datalist or losing focus)
                const changeHandler = function() {
                    // Clear any pending debounced call
                    if (debounceTimers[sourceId]) {
                        clearTimeout(debounceTimers[sourceId]);
                    }
                    loadDatabases(this.value, databasesListId);
                    loadFlows(this.value, flowsListId);
                };

                // Use debounced handler for 'input' (real-time as user types)
                element.addEventListener('input', inputHandler);
                // Use immediate handler for 'change' (selection from datalist)
                element.addEventListener('change', changeHandler);
            };

            // Attach listeners for all tabs
            attachSourceListeners('flows-source', 'databases-list-flows', 'flows-list-meta');
            attachSourceListeners('meta-source', 'databases-list-meta', 'flows-list-meta');
            attachSourceListeners('kb-source', 'databases-list-kb', 'flows-list-kb');
            attachSourceListeners('data-source', 'databases-list-data', 'flows-list-data');
            attachSourceListeners('compare-source', 'databases-list-compare', 'flows-list-compare');

            // When database changes, reload flows for that source+database
            document.getElementById('flows-database')?.addEventListener('change', function() {
                const source = document.getElementById('flows-source').value;
                if (source) {
                    loadFlows(source, 'flows-list-meta', this.value);
                }
            });

            // Data tab database change -> reload flows with filter
            document.getElementById('data-database')?.addEventListener('change', function() {
                const source = document.getElementById('data-source')?.value;
                if (source) {
                    loadFlows(source, 'flows-list-data', this.value);
                }
            });

            // Lazy-load flows when focusing the data-flow field if list is empty
            document.getElementById('data-flow')?.addEventListener('focus', function() {
                const dl = document.getElementById('flows-list-data');
                const hasOptions = dl && dl.children && dl.children.length > 0;
                const source = document.getElementById('data-source')?.value;
                const database = document.getElementById('data-database')?.value || '';
                if (!hasOptions && source) {
                    loadFlows(source, 'flows-list-data', database);
                }
            });

            // Lazy-load flows for compare tab
            document.getElementById('compare-flow')?.addEventListener('focus', function() {
                const dl = document.getElementById('flows-list-compare');
                const hasOptions = dl && dl.children && dl.children.length > 0;
                const source = document.getElementById('compare-source')?.value;
                const database = document.getElementById('compare-database')?.value || '';
                if (!hasOptions && source) {
                    loadFlows(source, 'flows-list-compare', database);
                }
            });
        }

        // ========================================================================
        // COMPARE TAB FUNCTIONALITY
        // ========================================================================

        // Store series to compare
        let comparisonSeries = [];

        /**
         * Add a series to the comparison list
         */
        function addSeriesToComparison() {
            const source = document.getElementById('compare-source').value.trim();
            const flow = document.getElementById('compare-flow').value.trim();
            const key = document.getElementById('compare-key').value.trim();
            const database = document.getElementById('compare-database').value.trim();
            const label = document.getElementById('compare-label').value.trim();

            if (!source || !flow || !key) {
                alert('Please enter source ID, flow ID, and key');
                return;
            }

            const series = {
                id: Date.now(), // Unique ID for this series
                source,
                flow,
                key,
                database: database || '',
                label: label || `${source}/${flow}/${key}`
            };

            comparisonSeries.push(series);
            renderComparisonSeriesList();

            // Clear the form
            document.getElementById('compare-source').value = '';
            document.getElementById('compare-flow').value = '';
            document.getElementById('compare-key').value = '';
            document.getElementById('compare-database').value = '';
            document.getElementById('compare-label').value = '';

            // Enable compare button
            document.getElementById('compare-btn').disabled = false;
        }

        /**
         * Render the list of series to compare
         */
        function renderComparisonSeriesList() {
            const listEl = document.getElementById('compare-series-list');

            if (comparisonSeries.length === 0) {
                listEl.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No series added yet. Add series using the form below.</p>';
                document.getElementById('compare-btn').disabled = true;
                return;
            }

            let html = '<div style="background: white; border: 2px solid #e0e0e0; border-radius: 6px; padding: 15px;">';
            html += '<h3 style="margin: 0 0 15px 0; color: #003D6D; font-size: 1.1em;">Series to Compare (' + comparisonSeries.length + ')</h3>';

            comparisonSeries.forEach((series, index) => {
                html += `
                    <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #003D6D; margin-bottom: 4px;">${series.label}</div>
                            <div style="font-size: 0.85em; color: #666;">
                                <span class="material-symbols-outlined" style="font-size: 14px;">source</span> ${series.source} &nbsp;
                                <span class="material-symbols-outlined" style="font-size: 14px;">data_object</span> ${series.flow} &nbsp;
                                <span class="material-symbols-outlined" style="font-size: 14px;">key</span> ${series.key}
                                ${series.database ? ` &nbsp;<span class="material-symbols-outlined" style="font-size: 14px;">database</span> ${series.database}` : ''}
                            </div>
                        </div>
                        <button onclick="removeSeriesFromComparison(${series.id})" style="background: #dc3545; border-color: #dc3545; padding: 8px 16px; min-width: auto;">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </div>
                `;
            });

            html += '</div>';
            listEl.innerHTML = html;
        }

        /**
         * Remove a series from comparison
         */
        function removeSeriesFromComparison(seriesId) {
            comparisonSeries = comparisonSeries.filter(s => s.id !== seriesId);
            renderComparisonSeriesList();
        }

        /**
         * Clear all series from comparison
         */
        function clearAllSeries() {
            if (comparisonSeries.length > 0 && !confirm('Clear all series from comparison?')) {
                return;
            }
            comparisonSeries = [];
            renderComparisonSeriesList();
            document.getElementById('compare-chart-wrapper').style.display = 'none';
        }

        /**
         * Fetch and compare all series
         */
        async function compareAllSeries() {
            if (comparisonSeries.length === 0) {
                alert('Please add at least one series to compare');
                return;
            }

            const compareBtn = document.getElementById('compare-btn');
            const originalBtnText = compareBtn.innerHTML;
            compareBtn.disabled = true;
            compareBtn.innerHTML = '<span class="material-symbols-outlined">hourglass_empty</span> Loading...';

            const chartWrapper = document.getElementById('compare-chart-wrapper');
            chartWrapper.style.display = 'none';

            try {
                // Fetch all series data in parallel
                const promises = comparisonSeries.map(series =>
                    fetchSeriesData(series.source, series.flow, series.key, series.database)
                );

                const results = await Promise.all(promises);

                // Combine all series into traces
                const allTraces = [];
                const allLabelsSet = new Set();
                const periodToDateMap = new Map();

                results.forEach((data, index) => {
                    const seriesLabel = comparisonSeries[index].label;

                    if (data && data.data && Array.isArray(data.data)) {
                        data.data.forEach((series, seriesIndex) => {
                            if (series.obs && Array.isArray(series.obs)) {
                                const dataMap = new Map();

                                series.obs.forEach(obs => {
                                    // Extract start from ISO period format (start/duration)
                                    let period = obs.period;
                                    if (period) {
                                        period = extractPeriodStart(period);
                                        const dateObj = parseToDate(period);
                                        if (dateObj) {
                                            periodToDateMap.set(period, dateObj);
                                        }
                                    }
                                    const value = parseFloat(obs.value);
                                    if (!isNaN(value) && period) {
                                        dataMap.set(period, value);
                                        allLabelsSet.add(period);
                                    }
                                });

                                if (dataMap.size > 0) {
                                    // Use custom label plus series key
                                    const traceName = data.data.length > 1
                                        ? `${seriesLabel} - ${series.key || 'Series ' + (seriesIndex + 1)}`
                                        : seriesLabel;

                                    // Sort labels by date
                                    const sortedLabels = Array.from(allLabelsSet).sort((a, b) => {
                                        const dateA = periodToDateMap.get(a);
                                        const dateB = periodToDateMap.get(b);
                                        if (dateA && dateB) {
                                            return dateA - dateB;
                                        }
                                        return a.localeCompare(b);
                                    });

                                    const allParsed = sortedLabels.every(label => periodToDateMap.has(label));
                                    const xValues = sortedLabels.map(label =>
                                        allParsed && periodToDateMap.has(label)
                                            ? periodToDateMap.get(label)
                                            : label
                                    );
                                    const yValues = sortedLabels.map(label => dataMap.get(label) ?? null);

                                    allTraces.push({
                                        x: xValues,
                                        y: yValues,
                                        mode: 'lines+markers',
                                        name: traceName,
                                        connectgaps: true,
                                        hovertemplate: allParsed
                                            ? '%{x|%Y-%m-%d}<br>%{y}<extra>' + traceName + '</extra>'
                                            : '%{x}<br>%{y}<extra>' + traceName + '</extra>'
                                    });
                                }
                            }
                        });
                    }
                });

                if (allTraces.length === 0) {
                    alert('No data available from any series');
                    return;
                }

                // Render comparison chart
                renderComparisonChart(allTraces, periodToDateMap);
                chartWrapper.style.display = 'block';

            } catch (error) {
                alert('Error fetching data: ' + error.message);
                console.error('Comparison error:', error);
            } finally {
                compareBtn.disabled = false;
                compareBtn.innerHTML = originalBtnText;
            }
        }

        /**
         * Fetch data for a single series
         */
        async function fetchSeriesData(source, flow, key, database) {
            const body = { source, flow, key };
            if (database) {
                body.database = database;
            }

            const response = await fetch(API_BASE + '/data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
            }

            return response.json();
        }

        /**
         * Render the comparison chart using Plotly
         */
        function renderComparisonChart(traces, periodToDateMap) {
            const chartDiv = document.getElementById('compare-chart');

            if (typeof Plotly === 'undefined') {
                chartDiv.innerHTML = '<div style="color:#cc0000; text-align:center; padding-top: 40px;">Error: Plotly library failed to load. Please refresh the page.</div>';
                console.error('Plotly is not defined');
                return;
            }

            // Check if using date axis
            const allLabels = new Set();
            traces.forEach(trace => {
                trace.x.forEach(x => {
                    if (x instanceof Date) {
                        allLabels.add(x.toISOString());
                    } else {
                        allLabels.add(x);
                    }
                });
            });

            const useDateAxis = traces[0]?.x[0] instanceof Date;

            const layout = {
                title: {
                    text: 'Time Series Comparison',
                    font: { size: 16, color: '#003D6D' }
                },
                xaxis: {
                    title: {
                        text: 'Time Period',
                        font: { size: 14, color: '#003D6D' }
                    },
                    type: useDateAxis ? 'date' : 'category',
                    tickangle: useDateAxis ? 0 : -45,
                    tickfont: { size: 11 },
                    showgrid: true,
                    gridcolor: '#e0e0e0',
                    gridwidth: 1,
                    showline: true,
                    linecolor: '#003D6D',
                    linewidth: 2,
                    rangeslider: {
                        visible: true,
                        bgcolor: '#f8f9fa',
                        bordercolor: '#003D6D',
                        borderwidth: 1,
                        thickness: 0.1
                    },
                    automargin: true
                },
                yaxis: {
                    title: {
                        text: 'Value',
                        font: { size: 14, color: '#003D6D' }
                    },
                    showgrid: true,
                    gridcolor: '#e0e0e0',
                    gridwidth: 1,
                    showline: true,
                    linecolor: '#003D6D',
                    linewidth: 2,
                    zeroline: true,
                    zerolinecolor: '#999',
                    zerolinewidth: 1
                },
                margin: { l: 60, r: 30, t: 60, b: useDateAxis ? 80 : 100 },
                legend: {
                    orientation: 'v',
                    x: 1.02,
                    xanchor: 'left',
                    y: 1,
                    yanchor: 'top',
                    bgcolor: 'rgba(255,255,255,0.9)',
                    bordercolor: '#e0e0e0',
                    borderwidth: 1
                },
                hovermode: 'x unified',
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#f8f9fa'
            };

            if (useDateAxis) {
                layout.xaxis.tickformat = '%Y-%m-%d';
                layout.xaxis.hoverformat = '%Y-%m-%d';
            }

            const config = { responsive: true, displayModeBar: true };

            try {
                Plotly.react(chartDiv, traces, layout, config);

                // Force resize
                setTimeout(() => {
                    try {
                        Plotly.Plots.resize(chartDiv);
                    } catch (e) {
                        console.warn('Initial Plotly resize failed:', e);
                    }
                }, 50);

                // Setup resize observer
                setupCompareChartResizeObserver();
            } catch (error) {
                chartDiv.innerHTML = '<div style="color:#cc0000; text-align:center; padding-top: 40px;">Error rendering chart: ' + error.message + '</div>';
                console.error('Plotly rendering error:', error);
            }
        }

        /**
         * Setup resize observer for comparison chart
         */
        function setupCompareChartResizeObserver() {
            const chartDiv = document.getElementById('compare-chart');
            const container = chartDiv?.parentElement;
            if (!chartDiv || !container || typeof Plotly === 'undefined') return;

            if (chartDiv._resizeObserver) {
                return;
            }

            let resizeTimeout = null;
            const triggerResize = () => {
                if (resizeTimeout) clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    try {
                        Plotly.Plots.resize(chartDiv);
                    } catch (e) {
                        console.warn('Plotly resize failed:', e);
                    }
                }, 100);
            };

            try {
                const ro = new ResizeObserver(() => triggerResize());
                ro.observe(container);
                chartDiv._resizeObserver = ro;
            } catch (e) {
                console.warn('ResizeObserver not available:', e);
            }

            const handleWindowResize = () => triggerResize();
            window.addEventListener('resize', handleWindowResize, { passive: true });
            chartDiv._windowResizeHandler = handleWindowResize;
        }

        // ========================================================================
        // FLOW SEARCH TAB FUNCTIONALITY
        // ========================================================================

        // IndexedDB setup
        const DB_NAME = 'sdmx-dl-flows-cache';
        const DB_VERSION = 1;
        const STORE_NAME = 'flows';
        let flowsDB = null;
        let searchDebounceTimer = null;
        let recentSearches = JSON.parse(localStorage.getItem('flowSearchHistory') || '[]');
        let currentSearchResults = [];

        /**
         * Initialize IndexedDB
         */
        function initFlowsDB() {
            return new Promise((resolve, reject) => {
                if (flowsDB) {
                    resolve(flowsDB);
                    return;
                }

                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    flowsDB = request.result;
                    resolve(flowsDB);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    // Create object store if it doesn't exist
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        store.createIndex('source', 'source', { unique: false });
                        store.createIndex('ref', 'ref', { unique: false });
                        store.createIndex('name', 'name', { unique: false });
                        store.createIndex('searchText', 'searchText', { unique: false });
                    }
                };
            });
        }

        /**
         * Save flows to IndexedDB
         */
        async function saveFlowsToDB(flows) {
            const db = await initFlowsDB();
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);

            flows.forEach(flow => {
                store.put(flow);
            });

            return new Promise((resolve, reject) => {
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
            });
        }

        /**
         * Get all flows from IndexedDB
         */
        async function getAllFlowsFromDB() {
            const db = await initFlowsDB();
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();

            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        /**
         * Clear flows cache from IndexedDB
         */
        async function clearFlowsFromDB() {
            const db = await initFlowsDB();
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.clear();

            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        /**
         * Get cache statistics
         */
        async function getCacheStats() {
            try {
                const flows = await getAllFlowsFromDB();
                const sources = new Set(flows.map(f => f.source));
                return {
                    totalFlows: flows.length,
                    totalSources: sources.size,
                    lastUpdated: flows.length > 0 ? flows[0].cachedAt : null
                };
            } catch (error) {
                return { totalFlows: 0, totalSources: 0, lastUpdated: null };
            }
        }

        /**
         * Update index status display
         */
        async function updateIndexStatus() {
            const stats = await getCacheStats();
            const statusEl = document.getElementById('index-status-text');

            if (stats.totalFlows > 0) {
                const date = stats.lastUpdated ? new Date(stats.lastUpdated).toLocaleString() : 'Unknown';
                statusEl.innerHTML = `<span class="material-symbols-outlined" style="color: #28a745;">check_circle</span> ${stats.totalFlows} flows from ${stats.totalSources} sources (cached: ${date})`;
            } else {
                statusEl.innerHTML = `<span class="material-symbols-outlined" style="color: #ffc107;">info</span> No flows indexed yet`;
            }
        }

        /**
         * Index all flows from all sources
         */
        async function indexAllFlows() {
            const btn = document.getElementById('index-flows-btn');
            const statusEl = document.getElementById('index-status-text');
            const progressContainer = document.getElementById('index-progress-container');
            const progressBar = document.getElementById('index-progress-bar');
            const progressText = document.getElementById('index-progress-text');
            const originalBtnText = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined">hourglass_empty</span> Indexing...';
            statusEl.innerHTML = '<span class="material-symbols-outlined">sync</span> Starting indexing process...';
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';

            try {
                // Step 1: Get all sources
                statusEl.innerHTML = '<span class="material-symbols-outlined">sync</span> Fetching sources...';
                progressBar.style.width = '10%';
                progressText.textContent = '10% - Fetching sources...';

                const sourcesResponse = await fetch(API_BASE + '/sources', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                if (!sourcesResponse.ok) {
                    throw new Error('Failed to fetch sources');
                }

                const sources = await sourcesResponse.json();
                statusEl.innerHTML = `<span class="material-symbols-outlined">sync</span> Found ${sources.length} sources. Fetching flows...`;
                progressBar.style.width = '20%';
                progressText.textContent = '20% - Found ' + sources.length + ' sources';

                // Step 2: Fetch flows from all sources in parallel
                const allFlows = [];
                const timestamp = Date.now();
                let processedSources = 0;

                const flowPromises = sources.map(async (source) => {
                    try {
                        const response = await fetch(API_BASE + '/flows', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ source: source.id })
                        });

                        if (response.ok) {
                            const flows = await response.json();
                            // Get first available name from names object, or use id as fallback
                            const sourceLabel = (source.names && Object.keys(source.names).length > 0)
                                ? Object.values(source.names)[0]
                                : source.id;

                            const enrichedFlows = flows.map(flow => ({
                                id: `${source.id}::${flow.ref}`,
                                source: source.id,
                                sourceLabel: sourceLabel,
                                ref: flow.ref,
                                name: flow.name || '',
                                description: flow.description || '',
                                searchText: `${source.id} ${sourceLabel} ${flow.ref} ${flow.name || ''} ${flow.description || ''}`.toLowerCase(),
                                cachedAt: timestamp
                            }));
                            allFlows.push(...enrichedFlows);
                        }
                        processedSources++;

                        // Update progress bar (20% to 80% for fetching)
                        const fetchProgress = 20 + Math.round((processedSources / sources.length) * 60);
                        progressBar.style.width = fetchProgress + '%';
                        progressText.textContent = `${fetchProgress}% - Processing sources: ${processedSources}/${sources.length}`;
                        statusEl.innerHTML = `<span class="material-symbols-outlined">sync</span> Processing sources: ${processedSources}/${sources.length}`;
                    } catch (error) {
                        console.warn(`Failed to fetch flows for source ${source.id}:`, error);
                        processedSources++;
                    }
                });

                await Promise.all(flowPromises);

                // Step 3: Save to IndexedDB
                statusEl.innerHTML = `<span class="material-symbols-outlined">sync</span> Saving ${allFlows.length} flows to cache...`;
                progressBar.style.width = '90%';
                progressText.textContent = '90% - Saving to cache...';

                await clearFlowsFromDB();
                await saveFlowsToDB(allFlows);

                // Step 4: Update status
                progressBar.style.width = '100%';
                progressText.textContent = '100% - Complete!';
                statusEl.innerHTML = `<span class="material-symbols-outlined" style="color: #28a745;">check_circle</span> Successfully indexed ${allFlows.length} flows from ${sources.length} sources!`;

                // Hide progress bar after 2 seconds
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 2000);

                updateIndexStatus();

            } catch (error) {
                statusEl.innerHTML = `<span class="material-symbols-outlined" style="color: #dc3545;">error</span> Error: ${error.message}`;
                progressContainer.style.display = 'none';
                console.error('Indexing error:', error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
            }
        }

        /**
         * Clear flows cache
         */
        async function clearFlowsCache() {
            if (!confirm('Are you sure you want to clear the cached flows?')) {
                return;
            }

            try {
                await clearFlowsFromDB();
                document.getElementById('index-status-text').innerHTML = '<span class="material-symbols-outlined" style="color: #ffc107;">info</span> Cache cleared';

                // Reset search UI
                document.getElementById('flowsearch-input').value = '';
                document.getElementById('flowsearch-clear-btn').style.display = 'none';
                document.getElementById('flowsearch-results-container').style.display = 'none';
                document.getElementById('flowsearch-empty-state').style.display = 'none';
            } catch (error) {
                alert('Error clearing cache: ' + error.message);
                console.error('Cache clear error:', error);
            }
        }

        /**
         * Debounced search for search-as-you-type
         */
        function debouncedFlowSearch() {
            // Clear existing timer
            if (searchDebounceTimer) {
                clearTimeout(searchDebounceTimer);
            }

            const query = document.getElementById('flowsearch-input').value.trim();

            // Show/hide clear button immediately
            document.getElementById('flowsearch-clear-btn').style.display = query ? 'block' : 'none';

            // If query is empty, clear results immediately
            if (!query) {
                document.getElementById('flowsearch-results-container').style.display = 'none';
                document.getElementById('flowsearch-empty-state').style.display = 'none';
                return;
            }

            // Wait 300ms before searching
            searchDebounceTimer = setTimeout(() => {
                performFlowSearch();
            }, 300);
        }

        /**
         * Perform flow search (Google-like)
         */
        async function performFlowSearch() {
            const searchInput = document.getElementById('flowsearch-input');
            const query = searchInput.value.trim();

            // Show/hide clear button
            document.getElementById('flowsearch-clear-btn').style.display = query ? 'block' : 'none';

            if (!query) {
                document.getElementById('flowsearch-results-container').style.display = 'none';
                document.getElementById('flowsearch-empty-state').style.display = 'none';
                return;
            }

            try {
                const startTime = performance.now();
                const allFlows = await getAllFlowsFromDB();

                if (allFlows.length === 0) {
                    alert('No flows indexed yet. Please click "Index All Flows" first.');
                    return;
                }

                // Get search options
                const options = {
                    matchCase: document.getElementById('flowsearch-case-check').checked,
                    wholeWords: document.getElementById('flowsearch-words-check').checked,
                    isRegex: document.getElementById('flowsearch-regex-check').checked,
                    isFuzzy: document.getElementById('flowsearch-fuzzy-check').checked
                };

                // Filter flows
                let results = [];
                if (options.isFuzzy) {
                    results = allFlows.filter(flow =>
                        fuzzyMatch(flow.searchText, query) ||
                        fuzzyMatch(flow.ref, query) ||
                        fuzzyMatch(flow.name, query) ||
                        fuzzyMatch(flow.description, query)
                    );
                } else if (options.isRegex) {
                    try {
                        const regex = new RegExp(query, options.matchCase ? '' : 'i');
                        results = allFlows.filter(flow =>
                            regex.test(flow.searchText) ||
                            regex.test(flow.ref) ||
                            regex.test(flow.name) ||
                            regex.test(flow.description)
                        );
                    } catch (e) {
                        alert('Invalid regular expression: ' + e.message);
                        return;
                    }
                } else {
                    let searchText = query;
                    if (!options.matchCase) {
                        searchText = searchText.toLowerCase();
                    }

                    if (options.wholeWords) {
                        const wordBoundary = new RegExp(`\\b${searchText}\\b`, options.matchCase ? '' : 'i');
                        results = allFlows.filter(flow =>
                            wordBoundary.test(flow.searchText) ||
                            wordBoundary.test(flow.ref) ||
                            wordBoundary.test(flow.name) ||
                            wordBoundary.test(flow.description)
                        );
                    } else {
                        results = allFlows.filter(flow => {
                            const text = options.matchCase ? flow.searchText : flow.searchText.toLowerCase();
                            const ref = options.matchCase ? flow.ref : flow.ref.toLowerCase();
                            const name = options.matchCase ? flow.name : flow.name.toLowerCase();
                            const desc = options.matchCase ? flow.description : flow.description.toLowerCase();

                            return text.includes(searchText) ||
                                   ref.includes(searchText) ||
                                   name.includes(searchText) ||
                                   desc.includes(searchText);
                        });
                    }
                }

                const endTime = performance.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);

                // Save to recent searches (only if results found)
                if (results.length > 0) {
                    saveRecentSearch(query);
                }

                // Display results
                if (results.length > 0) {
                    currentSearchResults = results; // Store for export
                    displayFlowSearchResults(results);
                    document.getElementById('flowsearch-results-info').innerHTML =
                        `About <strong>${results.length}</strong> result${results.length !== 1 ? 's' : ''} (${duration} seconds)`;
                    document.getElementById('flowsearch-results-container').style.display = 'block';
                    document.getElementById('flowsearch-empty-state').style.display = 'none';
                } else {
                    currentSearchResults = [];
                    document.getElementById('flowsearch-results-container').style.display = 'none';
                    document.getElementById('flowsearch-empty-state').style.display = 'block';
                }

            } catch (error) {
                alert('Search error: ' + error.message);
                console.error('Search error:', error);
            }
        }

        /**
         * Clear flow search
         */
        function clearFlowSearch() {
            document.getElementById('flowsearch-input').value = '';
            document.getElementById('flowsearch-clear-btn').style.display = 'none';
            document.getElementById('flowsearch-results-container').style.display = 'none';
            document.getElementById('flowsearch-empty-state').style.display = 'none';
        }

        /**
         * Save search to recent history
         */
        function saveRecentSearch(query) {
            if (!query || query.length < 2) return;

            // Remove if already exists
            recentSearches = recentSearches.filter(s => s !== query);

            // Add to beginning
            recentSearches.unshift(query);

            // Keep only last 10
            recentSearches = recentSearches.slice(0, 10);

            // Save to localStorage
            localStorage.setItem('flowSearchHistory', JSON.stringify(recentSearches));
        }

        /**
         * Clear recent searches
         */
        function clearRecentSearches() {
            recentSearches = [];
            localStorage.removeItem('flowSearchHistory');
            displayRecentSearches();
        }

        /**
         * Display recent searches as clickable chips
         */
        function displayRecentSearches() {
            const container = document.getElementById('recent-searches-container');
            if (!container) return;

            if (recentSearches.length === 0) {
                container.style.display = 'none';
                return;
            }

            let html = '<div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-top: 10px;">';
            html += '<span style="font-size: 12px; color: #666;">Recent:</span>';

            recentSearches.forEach(search => {
                html += `<button
                    onclick="runRecentSearch('${escapeHtml(search).replace(/'/g, "\\'")}')"
                    style="padding: 4px 12px; background: #f1f3f4; border: 1px solid #dadce0; border-radius: 16px; color: #3c4043; font-size: 13px; cursor: pointer; transition: all 0.2s;"
                    onmouseover="this.style.background='#e8eaed';"
                    onmouseout="this.style.background='#f1f3f4';">${escapeHtml(search)}</button>`;
            });

            html += `<button
                onclick="clearRecentSearches()"
                style="padding: 4px 8px; background: transparent; border: none; color: #5f6368; font-size: 12px; cursor: pointer;"
                title="Clear history"></button>`;
            html += '</div>';

            container.innerHTML = html;
            container.style.display = 'block';
        }

        /**
         * Run a recent search
         */
        function runRecentSearch(query) {
            document.getElementById('flowsearch-input').value = query;
            performFlowSearch();
        }

        /**
         * Export flow search results as CSV
         */
        function exportFlowSearchResults() {
            if (currentSearchResults.length === 0) {
                alert('No results to export');
                return;
            }

            // Create CSV content
            const headers = ['Source', 'Source Label', 'Flow Reference', 'Flow Name', 'Description'];
            const csvRows = [headers.join(',')];

            currentSearchResults.forEach(flow => {
                const row = [
                    escapeCsvValue(flow.source),
                    escapeCsvValue(flow.sourceLabel),
                    escapeCsvValue(flow.ref),
                    escapeCsvValue(flow.name),
                    escapeCsvValue(flow.description)
                ];
                csvRows.push(row.join(','));
            });

            const csvContent = csvRows.join('\n');

            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `flow-search-results-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Escape CSV value (handle commas, quotes, newlines)
         */
        function escapeCsvValue(value) {
            if (value == null) return '';
            value = String(value);

            // If value contains comma, quote, or newline, wrap in quotes and escape internal quotes
            if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                value = '"' + value.replace(/"/g, '""') + '"';
            }

            return value;
        }

        /**
         * Legacy filter function - now redirects to search
         */
        function filterFlowSearchResults() {
            // Redirect to new search function
            performFlowSearch();
        }

        /**
         * Clear filter - now redirects to clear search
         */
        function clearFlowSearchFilter() {
            clearFlowSearch();
        }

        /**
         * Toggle search option (deprecated - now using checkboxes)
         */
        function toggleFlowSearchOption(option) {
            // Legacy function - kept for backward compatibility
            // Now using checkboxes instead
        }

        /**
         * Highlight matching terms in text
         */
        function highlightMatches(text, query) {
            if (!text || !query) return escapeHtml(text || '');

            const escapedText = escapeHtml(text);
            const searchTerm = query.trim();

            if (!searchTerm) return escapedText;

            // Simple case-insensitive highlighting
            const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return escapedText.replace(regex, '<mark style="background: #fff59d; padding: 0 2px; border-radius: 2px; font-weight: 500;">$1</mark>');
        }

        /**
         * Display flow search results
         */
        function displayFlowSearchResults(flows) {
            const resultsEl = document.getElementById('flowsearch-results');

            if (flows.length === 0) {
                resultsEl.innerHTML = '<div style="color: #666; padding: 40px; text-align: center;">No flows found</div>';
                return;
            }


            // Group flows by source
            const flowsBySource = {};
            flows.forEach(flow => {
                if (!flowsBySource[flow.source]) {
                    flowsBySource[flow.source] = [];
                }
                flowsBySource[flow.source].push(flow);
            });

            let html = '';

            // Sort sources alphabetically
            const sortedSources = Object.keys(flowsBySource).sort();

            sortedSources.forEach(sourceName => {
                const sourceFlows = flowsBySource[sourceName];
                const sourceLabel = sourceFlows[0].sourceLabel;

                html += `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #003D6D; font-size: 1.1em; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-left: 4px solid #0066cc; display: flex; align-items: center; gap: 8px;">
                            <span class="material-symbols-outlined">source</span>
                            ${sourceLabel} (${sourceName})
                            <span style="margin-left: auto; font-size: 0.9em; font-weight: normal; color: #666;">${sourceFlows.length} flow${sourceFlows.length !== 1 ? 's' : ''}</span>
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 15px;">
                `;

                sourceFlows.forEach(flow => {
                    const iconSvg = getFlowIcon(flow);
                    const searchQuery = document.getElementById('flowsearch-input').value.trim();

                    html += `
                        <div class="flow-card" onclick="toggleFlowSearchActions(this)">
                            <div class="flow-header">
                                <div class="flow-icon">${iconSvg}</div>
                                <div class="flow-title">
                                    <h4 class="flow-id">${highlightMatches(flow.ref, searchQuery)}</h4>
                                    ${flow.name ? `<p class="flow-name">${highlightMatches(flow.name, searchQuery)}</p>` : ''}
                                </div>
                            </div>
                            ${flow.description ? `<div class="flow-description">${highlightMatches(flow.description, searchQuery)}</div>` : ''}
                            <div class="flow-click-hint">Click card to show actions</div>
                            <div class="flow-actions">
                                <div class="flow-actions-title">Use in Other Tabs</div>
                                <div class="flow-action-buttons">
                                    <button class="flow-action-btn" onclick="event.stopPropagation(); useFlowSearchInTab('${escapeHtml(flow.source)}', '${escapeHtml(flow.ref)}', '', 'meta')" title="Get meta for this flow"><span class="material-symbols-outlined">info</span> Meta</button>
                                    <button class="flow-action-btn" onclick="event.stopPropagation(); useFlowSearchInTab('${escapeHtml(flow.source)}', '${escapeHtml(flow.ref)}', '', 'keybuilder')" title="Use in key builder"><span class="material-symbols-outlined">vpn_key</span> Key Builder</button>
                                    <button class="flow-action-btn" onclick="event.stopPropagation(); useFlowSearchInTab('${escapeHtml(flow.source)}', '${escapeHtml(flow.ref)}', '', 'data')" title="Use in data tab"><span class="material-symbols-outlined">analytics</span> Data</button>
                                    <button class="flow-action-btn" onclick="event.stopPropagation(); useFlowSearchInTab('${escapeHtml(flow.source)}', '${escapeHtml(flow.ref)}', '', 'compare')" title="Use in compare tab"><span class="material-symbols-outlined">compare_arrows</span> Compare</button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            resultsEl.innerHTML = html;
        }

        /**
         * Toggle flow search card actions
         */
        function toggleFlowSearchActions(card) {
            const wasExpanded = card.classList.contains('expanded');

            // Collapse all other cards
            document.querySelectorAll('#flowsearch-results .flow-card').forEach(c => {
                c.classList.remove('expanded');
            });

            // Toggle current card
            if (!wasExpanded) {
                card.classList.add('expanded');
            }
        }

        /**
         * Use flow from search in another tab
         */
        function useFlowSearchInTab(source, flowId, database, tabName) {
            // Fill the appropriate fields in the target tab
            switch(tabName) {
                case 'meta':
                    document.getElementById('meta-source').value = source;
                    document.getElementById('meta-flow').value = flowId;
                    if (database) {
                        document.getElementById('meta-database').value = database;
                    }
                    switchTab('meta');
                    break;
                case 'keybuilder':
                    document.getElementById('kb-source').value = source;
                    document.getElementById('kb-flow').value = flowId;
                    if (database) {
                        document.getElementById('kb-database').value = database;
                    }
                    switchTab('keybuilder');
                    break;
                case 'data':
                    document.getElementById('data-source').value = source;
                    document.getElementById('data-flow').value = flowId;
                    if (database) {
                        document.getElementById('data-database').value = database;
                    }
                    switchTab('data');
                    break;
                case 'compare':
                    document.getElementById('compare-source').value = source;
                    document.getElementById('compare-flow').value = flowId;
                    if (database) {
                        document.getElementById('compare-database').value = database;
                    }
                    switchTab('compare');
                    break;
            }
        }

        // ========================================================================
        // INITIALIZATION
        // ========================================================================

        /**
         * Initialize the application on page load
         */
        window.addEventListener('DOMContentLoaded', () => {
            // Check for callback URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const callbackParam = urlParams.get('callback');
            if (callbackParam) {
                keyBuilderCallbackUrl = callbackParam;
            }

            // Load form values from URL parameters FIRST (before setting up listeners)
            // This prevents change events from firing during URL parameter loading
            loadFormFromUrl();

            // Initialize view control buttons
            initializeViewControls();

            // Now set up the rest of the application
            getAbout();
            loadSources();
            setupAutocomplete();

            // Auto-load sources on page load (loads in background for all tabs)
            getSources();

            // Initialize compare tab
            renderComparisonSeriesList();

            // Initialize flow search tab - just check cache status
            updateIndexStatus();
            displayRecentSearches();

            // Pre-populate Data tab flows if source already present (e.g., from URL)
            const prefillDataSource = document.getElementById('data-source')?.value;
            if (prefillDataSource) {
                const prefillDatabase = document.getElementById('data-database')?.value || '';
                loadFlows(prefillDataSource, 'flows-list-data', prefillDatabase);
            }

            // Setup URL synchronization with forms (after URL loading is complete)
            setupFormUrlSync();

            // Close view menu when clicking outside
            document.addEventListener('click', (e) => {
                const viewMenu = document.getElementById('view-menu');
                const viewMenuBtn = document.getElementById('view-menu-btn');

                if (viewMenu && viewMenuBtn) {
                    if (!viewMenuBtn.contains(e.target) && !viewMenu.contains(e.target)) {
                        viewMenu.style.display = 'none';
                    }
                }
            });

            // Close help modal when clicking outside or pressing Escape
            const modal = document.getElementById('url-params-modal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeUrlParamsHelp();
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && modal.style.display === 'flex') {
                        closeUrlParamsHelp();
                    }
                });
            }
        });

        /**
         * Handle browser back/forward buttons
         */
        window.addEventListener('popstate', (event) => {
            if (event.state?.tab) {
                switchTab(event.state.tab, true);
            } else {
                // Reload from URL if no state
                loadFormFromUrl();
            }
        });
    </script>
</body>
</html>

